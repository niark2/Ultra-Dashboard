var I=(r,e)=>()=>(r&&(e=r(r=0)),e);var Me=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var N,se=I(()=>{N=class{constructor(){this.navItems=document.querySelectorAll(".nav-item"),this.tabContents=document.querySelectorAll(".tab-content"),this.currentTab="convert",this.init()}init(){this.navItems.forEach(e=>{e.addEventListener("click",()=>{if(e.disabled)return;let t=e.dataset.tab;this.switchTab(t)})}),document.addEventListener("switch-tab",e=>{e.detail&&e.detail.tab&&this.switchTab(e.detail.tab)})}switchTab(e){document.querySelectorAll(".nav-item").forEach(s=>{let n=s.dataset.tab===e;if(s.classList.toggle("active",n),n){let i=s.closest(".nav-section");i&&i.classList.remove("collapsed")}}),this.tabContents.forEach(s=>{s.classList.toggle("active",s.id===`tab-${e}`)}),this.currentTab=e,console.log(`Tab switched to: ${e}`)}}});var P,M,U,ee,x,F=I(()=>{P=r=>{if(r===0)return"0 B";let e=1024,t=["B","KB","MB","GB","TB"],s=Math.floor(Math.log(r)/Math.log(e));return parseFloat((r/Math.pow(e,s)).toFixed(2))+" "+t[s]},M=r=>P(r)+"/s",U=r=>{if(!r||r<=0)return"0:00";let e=Math.floor(r/3600),t=Math.floor(r%3600/60),s=Math.floor(r%60);return e>0?`${e}:${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${t}:${s.toString().padStart(2,"0")}`},ee=r=>{if(r>=864e4)return"\u221E";if(r<=0)return"Termin\xE9";let t=Math.floor(r/3600),s=Math.floor(r%3600/60);return t>0?`${t}h ${s}m`:s>0?`${s}m`:`${r}s`},x=()=>{window.lucide&&window.lucide.createIcons()}});var q,ne=I(()=>{F();q=class{constructor(){this.selectedFile=null,this.selectedFormat=null,this.supportedFormats=null,this.compressEnabled=!1,this.compressQuality=75,this.elements={dropZone:document.getElementById("dropZone"),fileInput:document.getElementById("fileInput"),fileInfo:document.getElementById("fileInfo"),formatSection:document.getElementById("formatSection"),formatGrid:document.getElementById("formatGrid"),convertBtn:document.getElementById("convertBtn"),progressContainer:document.getElementById("progressContainer"),successMessage:document.getElementById("successMessage"),fileName:document.getElementById("fileName"),fileSize:document.getElementById("fileSize"),convertOptions:document.getElementById("convertOptions"),compressToggle:document.getElementById("compressToggle")},this.init()}async init(){this.setupEventListeners(),await this.loadFormats()}setupEventListeners(){this.elements.dropZone.onclick=()=>this.elements.fileInput.click(),this.elements.fileInput.onchange=e=>e.target.files[0]&&this.handleFile(e.target.files[0]),document.getElementById("removeFile").onclick=()=>this.reset(),this.elements.convertBtn.onclick=()=>this.processFile(),this.elements.dropZone.ondragover=e=>{e.preventDefault(),this.elements.dropZone.classList.add("drag-over")},this.elements.dropZone.ondragleave=()=>this.elements.dropZone.classList.remove("drag-over"),this.elements.dropZone.ondrop=e=>{e.preventDefault(),this.elements.dropZone.classList.remove("drag-over"),e.dataTransfer.files.length&&this.handleFile(e.dataTransfer.files[0])},this.elements.compressToggle.onchange=e=>{this.compressEnabled=e.target.checked,this.updateButtonState()}}handleFile(e){this.selectedFile=e,this.elements.dropZone.classList.add("hidden"),this.elements.fileInfo.classList.remove("hidden"),this.elements.formatSection.classList.remove("hidden"),this.elements.convertOptions.classList.remove("hidden"),this.elements.successMessage.classList.add("hidden"),this.elements.fileName.textContent=e.name,this.elements.fileSize.textContent=P(e.size);let t=e.name.split(".").pop().toLowerCase(),s=document.getElementById("imagePreview"),n=document.getElementById("fileIconLarge");if(["jpg","jpeg","png","webp","gif","avif","tiff"].includes(t))s.src=URL.createObjectURL(e),s.classList.remove("hidden"),n.classList.add("hidden");else{s.classList.add("hidden"),n.classList.remove("hidden");let i=this.getIcon(t);n.innerHTML=`<i data-lucide="${i}"></i>`,x()}this.generateButtons(t),this.updateButtonState()}getIcon(e){return["pdf","docx","odt","rtf","epub","txt","md","html"].includes(e)?"file-text":["mp3","wav","flac","ogg","m4a","aac"].includes(e)?"music":["mp4","mov","avi","webm","mkv"].includes(e)?"video":"package"}async loadFormats(){try{let e=await fetch("/api/convert/formats");this.supportedFormats=await e.json()}catch(e){console.error("Erreur chargement formats",e)}}generateButtons(e){let t=this.elements.formatGrid;t.innerHTML="";let s=[],n=this.supportedFormats;n&&(n.image.includes(e)?s=n.image:n.audio.includes(e)?s=n.audio:n.video.includes(e)?s=n.video:(n.document.includes(e),s=n.document),(n.document.includes(e)||n.image.includes(e))&&(s.includes("pdf")||s.push("pdf"),s.includes("docx")||s.push("docx"),s.includes("md")||s.push("md"),s.includes("txt")||s.push("txt")),s.filter(i=>i!==e).sort().forEach(i=>{let a=document.createElement("button");a.className="format-btn",a.textContent=i.toUpperCase(),a.onclick=()=>{document.querySelectorAll(".format-btn").forEach(o=>o.classList.remove("selected")),a.classList.add("selected"),this.selectedFormat=i,this.updateButtonState()},t.appendChild(a)}))}updateButtonState(){let e=this.selectedFormat||this.compressEnabled;this.elements.convertBtn.classList.toggle("hidden",!e);let t=this.elements.convertBtn.querySelector(".btn-text");this.selectedFormat&&this.compressEnabled?t.innerHTML='<i data-lucide="refresh-cw" class="inline-icon"></i> Convertir & Compresser':this.compressEnabled?t.innerHTML='<i data-lucide="package" class="inline-icon"></i> Compresser':t.innerHTML='<i data-lucide="refresh-cw" class="inline-icon"></i> Convertir',x()}async processFile(){this.elements.convertBtn.disabled=!0,this.elements.progressContainer.classList.remove("hidden");let e=this.elements.convertBtn.querySelector(".btn-text"),t=e.textContent;e.textContent="Traitement en cours...";let s=new FormData;s.append("file",this.selectedFile),this.selectedFormat&&s.append("targetFormat",this.selectedFormat),s.append("compress",this.compressEnabled.toString()),s.append("quality",this.compressQuality.toString());try{let n=await fetch("/api/convert",{method:"POST",body:s});if(!n.ok){let c=await n.json();throw new Error(c.error||"Erreur lors du traitement")}let i=await n.blob(),a=document.createElement("a");a.href=URL.createObjectURL(i);let o=this.selectedFormat||this.selectedFile.name.split(".").pop().toLowerCase(),l=this.selectedFile.name.replace(/\.[^/.]+$/,""),m=this.compressEnabled?"-compressed":"";a.download=`${l}${m}.${o}`,a.click(),this.elements.successMessage.classList.remove("hidden")}catch(n){alert("\u{1F6A8} "+n.message)}finally{this.elements.convertBtn.disabled=!1,e.textContent=t,this.elements.progressContainer.classList.add("hidden")}}reset(){this.selectedFile=null,this.selectedFormat=null,this.compressEnabled=!1,this.compressQuality=75,this.elements.dropZone.classList.remove("hidden"),this.elements.fileInfo.classList.add("hidden"),this.elements.formatSection.classList.add("hidden"),this.elements.convertOptions.classList.add("hidden"),this.elements.convertBtn.classList.add("hidden"),this.elements.successMessage.classList.add("hidden"),this.elements.fileInput.value="",this.elements.compressToggle.checked=!1}}});var j,ie=I(()=>{F();j=class{constructor(){this.elements={urlInput:document.getElementById("ytUrl"),searchBtn:document.getElementById("ytSearchBtn"),preview:document.getElementById("ytPreview"),loading:document.getElementById("ytLoading"),thumbnail:document.getElementById("ytThumbnail"),title:document.getElementById("ytTitle"),channel:document.getElementById("ytChannel"),duration:document.getElementById("ytDuration"),downloadBtn:document.getElementById("ytDownloadBtn"),modeToggles:document.querySelectorAll(".mode-toggle .toggle-btn"),qualitySelect:document.getElementById("ytQuality"),formatSelect:document.getElementById("ytFormat"),advancedBtn:document.getElementById("ytAdvancedBtn"),advancedPanel:document.getElementById("ytAdvancedOptions"),chkMetadata:document.getElementById("chkMetadata"),chkThumbnail:document.getElementById("chkThumbnail"),chkSubs:document.getElementById("chkSubs"),trimStart:document.getElementById("trimStart"),trimEnd:document.getElementById("trimEnd"),containerSubtitles:document.getElementById("containerSubtitles"),emptyState:document.getElementById("ytEmptyState"),historyList:document.getElementById("ytHistoryList"),clearHistoryBtn:document.getElementById("btnClearYtHistory")},this.currentMode="video",this.currentUrl="",this.videoInfo=null,this.init()}init(){this.elements.searchBtn.onclick=()=>this.fetchInfo(),this.elements.urlInput.onkeypress=e=>{e.key==="Enter"&&this.fetchInfo()},this.elements.modeToggles.forEach(e=>{e.onclick=()=>{this.elements.modeToggles.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.setMode(e.dataset.mode)}}),this.elements.advancedBtn.onclick=()=>{this.elements.advancedPanel.classList.toggle("hidden")},this.elements.downloadBtn.onclick=()=>this.download(),this.elements.clearHistoryBtn.onclick=()=>this.clearHistory(),this.loadHistory()}setMode(e){this.currentMode=e;let t=this.elements.formatSelect;t.innerHTML="",e==="video"?(["mp4","mkv","webm"].forEach(s=>{t.add(new Option(s.toUpperCase(),s))}),this.elements.qualitySelect.disabled=!1,this.elements.chkSubs.disabled=!1,this.elements.containerSubtitles.style.opacity="1"):(["mp3","m4a","wav","flac"].forEach(s=>{t.add(new Option(s.toUpperCase(),s))}),this.elements.qualitySelect.disabled=!0,this.elements.chkSubs.disabled=!0,this.elements.chkSubs.checked=!1,this.elements.containerSubtitles.style.opacity="0.5"),this.videoInfo&&e==="video"&&this.populateQualities(this.videoInfo.resolutions)}async fetchInfo(){let e=this.elements.urlInput.value.trim();if(e){this.currentUrl=e,this.showLoading(!0),this.elements.preview.classList.add("hidden"),this.elements.emptyState.classList.add("hidden");try{let s=await(await fetch(`/api/youtube/info?url=${encodeURIComponent(e)}`)).json();if(s.error)throw new Error(s.error);this.videoInfo=s,this.updatePreview(s)}catch(t){alert("Erreur: "+t.message)}finally{this.showLoading(!1)}}}updatePreview(e){this.elements.thumbnail.src=e.thumbnail,this.elements.title.textContent=e.title,this.elements.channel.textContent=e.channel||"YouTube Video",this.elements.duration.textContent=U(e.duration),this.populateQualities(e.resolutions),this.setMode("video"),this.elements.preview.classList.remove("hidden"),this.elements.emptyState.classList.add("hidden")}async addToHistory(e){let t=await this.getHistory(),s={id:Date.now(),title:e.title,thumbnail:e.thumbnail,platform:"YouTube",timestamp:new Date().toISOString()};t=t.filter(n=>n.title!==e.title),t.unshift(s),t=t.slice(0,10),localStorage.setItem("ultra-yt-history",JSON.stringify(t)),this.renderHistory(t)}async getHistory(){let e=localStorage.getItem("ultra-yt-history");return e?JSON.parse(e):[]}async loadHistory(){let e=await this.getHistory();this.renderHistory(e)}renderHistory(e){let t=this.elements.historyList;if(!e||e.length===0){t.innerHTML='<p class="empty-history-text">Aucun t\xE9l\xE9chargement r\xE9cent</p>';return}t.innerHTML=e.map(s=>`
            <div class="history-item">
                <img src="${s.thumbnail}" class="history-item-thumb">
                <div class="history-item-info">
                    <div class="history-item-title">${s.title}</div>
                    <div class="history-item-meta">YOUTUBE \u2022 ${new Date(s.timestamp).toLocaleDateString()}</div>
                </div>
            </div>
        `).join(""),x()}clearHistory(){localStorage.removeItem("ultra-yt-history"),this.renderHistory([])}populateQualities(e){let t=this.elements.qualitySelect;t.innerHTML='<option value="best">Auto (Max)</option>',e&&e.length&&e.forEach(s=>{let n=s>=2160?"4K/2160p":s>=1440?"2K/1440p":s>=1080?"1080p":`${s}p`;t.add(new Option(n,s))})}async download(){let e=this.elements.downloadBtn,t=e.querySelector(".btn-text"),s=e.querySelector(".btn-loader"),n=Date.now().toString();e.disabled=!0,t.textContent="Initialisation...",s.classList.remove("hidden");let i=document.getElementById("ytProgressContainer"),a=document.getElementById("ytProgressFill"),o=document.getElementById("ytProgressStatus"),l=document.getElementById("ytProgressPercent");i&&(i.classList.remove("hidden"),a.style.width="0%",o.textContent="D\xE9marrage...",l.textContent="0%");let m=new EventSource(`/api/youtube/progress/${n}`);m.onmessage=c=>{let d=JSON.parse(c.data);d.type==="progress"?(a&&(a.style.width=`${d.percent}%`),l&&(l.textContent=`${Math.round(d.percent)}%`),o&&(o.textContent=d.status),t.textContent=`${d.status} (${Math.round(d.percent)}%)`):d.type==="complete"&&(a&&(a.style.width="100%"),l&&(l.textContent="100%"),o&&(o.textContent="Pr\xEAt pour le t\xE9l\xE9chargement !"),t.textContent="Finalisation...",this.addToHistory(this.videoInfo))},m.onerror=()=>{m.close()};try{let c={url:this.currentUrl,videoId:n,mode:this.currentMode,quality:this.elements.qualitySelect.value,format:this.elements.formatSelect.value,embedMetadata:this.elements.chkMetadata.checked,embedThumbnail:this.elements.chkThumbnail.checked,embedSubs:this.elements.chkSubs.checked,trimStart:this.elements.trimStart.value,trimEnd:this.elements.trimEnd.value},d=await fetch("/api/youtube/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!d.ok){let v=await d.json();throw new Error(v.error||"Erreur inconnue")}m.close();let f=await d.blob(),E=URL.createObjectURL(f),w=document.createElement("a");w.href=E;let T=this.videoInfo?`${this.videoInfo.title}.${c.format}`:`video.${c.format}`;w.download=T,w.click(),URL.revokeObjectURL(E),o&&(o.textContent="T\xE9l\xE9charg\xE9 !")}catch(c){m.close(),alert("Erreur: "+c.message),o&&(o.textContent="\xC9chec")}finally{e.disabled=!1,t.textContent="T\xE9l\xE9charger",s.classList.add("hidden"),setTimeout(()=>{i&&i.classList.add("hidden")},5e3)}}showLoading(e){e?this.elements.loading.classList.remove("hidden"):(this.elements.loading.classList.add("hidden"),this.elements.preview.classList.contains("hidden")&&this.elements.emptyState.classList.remove("hidden"))}}});var z,ae=I(()=>{F();z=class{constructor(){this.elements={urlInput:document.getElementById("socialUrl"),searchBtn:document.getElementById("socialSearchBtn"),preview:document.getElementById("socialPreview"),loading:document.getElementById("socialLoading"),thumbnail:document.getElementById("socialThumbnail"),title:document.getElementById("socialTitle"),channel:document.getElementById("socialChannel"),duration:document.getElementById("socialDuration"),downloadBtn:document.getElementById("socialDownloadBtn"),modeToggles:document.querySelectorAll(".social-mode-toggle .toggle-btn"),qualitySelect:document.getElementById("socialQuality"),formatSelect:document.getElementById("socialFormat"),progressContainer:document.getElementById("socialProgressContainer"),progressFill:document.getElementById("socialProgressFill"),progressStatus:document.getElementById("socialProgressStatus"),progressPercent:document.getElementById("socialProgressPercent"),emptyState:document.getElementById("socialEmptyState"),historyList:document.getElementById("socialHistoryList"),clearHistoryBtn:document.getElementById("btnClearSocialHistory")},this.currentMode="video",this.currentUrl="",this.mediaInfo=null,this.elements.urlInput&&this.init()}init(){this.elements.searchBtn.onclick=()=>this.fetchInfo(),this.elements.urlInput.onkeypress=e=>{e.key==="Enter"&&this.fetchInfo()},this.elements.modeToggles.forEach(e=>{e.onclick=()=>{this.elements.modeToggles.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.setMode(e.dataset.mode)}}),this.elements.downloadBtn.onclick=()=>this.download(),this.elements.clearHistoryBtn.onclick=()=>this.clearHistory(),this.loadHistory(),this.setMode("video")}setMode(e){this.currentMode=e;let t=this.elements.formatSelect;t.innerHTML="",e==="video"?(["mp4","mkv","webm"].forEach(s=>{t.add(new Option(s.toUpperCase(),s))}),this.elements.qualitySelect.disabled=!1):(["mp3","m4a","wav","opus"].forEach(s=>{t.add(new Option(s.toUpperCase(),s))}),this.elements.qualitySelect.disabled=!0),this.mediaInfo&&e==="video"&&this.populateQualities(this.mediaInfo.resolutions)}async fetchInfo(){let e=this.elements.urlInput.value.trim();if(e){this.currentUrl=e,this.showLoading(!0),this.elements.preview.classList.add("hidden"),this.elements.emptyState.classList.add("hidden");try{let s=await(await fetch(`/api/social/info?url=${encodeURIComponent(e)}`)).json();if(s.error)throw new Error(s.error);this.mediaInfo=s,this.updatePreview(s)}catch(t){alert("Erreur: "+t.message)}finally{this.showLoading(!1)}}}updatePreview(e){this.elements.thumbnail.src=e.thumbnail||"/img/social-placeholder.png",this.elements.title.textContent=e.title,this.elements.channel.textContent=e.platform.toUpperCase()+(e.channel?` \u2022 ${e.channel}`:""),this.elements.duration.textContent=U(e.duration),this.populateQualities(e.resolutions),this.setMode(this.currentMode),this.elements.preview.classList.remove("hidden"),this.elements.emptyState.classList.add("hidden")}async addToHistory(e){let t=await this.getHistory(),s={id:Date.now(),title:e.title,thumbnail:e.thumbnail,platform:e.platform,timestamp:new Date().toISOString()};t=t.filter(n=>n.title!==e.title),t.unshift(s),t=t.slice(0,10),await localStorage.setItem("ultra-social-history",JSON.stringify(t)),this.renderHistory(t)}async getHistory(){let e=localStorage.getItem("ultra-social-history");return e?JSON.parse(e):[]}async loadHistory(){let e=await this.getHistory();this.renderHistory(e)}renderHistory(e){let t=this.elements.historyList;if(!e||e.length===0){t.innerHTML='<p class="empty-history-text">Aucun t\xE9l\xE9chargement r\xE9cent</p>';return}t.innerHTML=e.map(s=>`
            <div class="history-item">
                <img src="${s.thumbnail||"/img/social-placeholder.png"}" class="history-item-thumb">
                <div class="history-item-info">
                    <div class="history-item-title">${s.title}</div>
                    <div class="history-item-meta">${s.platform.toUpperCase()} \u2022 ${new Date(s.timestamp).toLocaleDateString()}</div>
                </div>
            </div>
        `).join(""),x()}clearHistory(){localStorage.removeItem("ultra-social-history"),this.renderHistory([])}populateQualities(e){let t=this.elements.qualitySelect;t.innerHTML='<option value="best">Auto (Max)</option>',e&&e.length&&e.forEach(s=>{let n=s>=2160?"4K/2160p":s>=1080?"1080p":`${s}p`;t.add(new Option(n,s))})}async download(){let e=this.elements.downloadBtn,t=e.querySelector(".btn-text"),s=e.querySelector(".btn-loader"),n=Date.now().toString();e.disabled=!0,t.textContent="Initialisation...",s.classList.remove("hidden"),this.elements.progressContainer&&(this.elements.progressContainer.classList.remove("hidden"),this.elements.progressFill.style.width="0%",this.elements.progressStatus.textContent="D\xE9marrage...",this.elements.progressPercent.textContent="0%");let i=new EventSource(`/api/social/progress/${n}`);i.onmessage=a=>{let o=JSON.parse(a.data);o.type==="progress"?(this.elements.progressFill&&(this.elements.progressFill.style.width=`${o.percent}%`),this.elements.progressPercent&&(this.elements.progressPercent.textContent=`${Math.round(o.percent)}%`),this.elements.progressStatus&&(this.elements.progressStatus.textContent=o.status),t.textContent=`${o.status} (${Math.round(o.percent)}%)`):o.type==="complete"&&(this.elements.progressFill&&(this.elements.progressFill.style.width="100%"),this.elements.progressPercent&&(this.elements.progressPercent.textContent="100%"),this.elements.progressStatus&&(this.elements.progressStatus.textContent="Pr\xEAt !"),t.textContent="T\xE9l\xE9chargement...",this.addToHistory(this.mediaInfo))};try{let a={url:this.currentUrl,downloadId:n,mode:this.currentMode,quality:this.elements.qualitySelect.value,format:this.elements.formatSelect.value},o=await fetch("/api/social/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok){let f=await o.json();throw new Error(f.error||"Erreur inconnue")}i.close();let l=await o.blob(),m=URL.createObjectURL(l),c=document.createElement("a");c.href=m;let d=this.mediaInfo?`${this.mediaInfo.title}.${a.format}`:`download.${a.format}`;c.download=d,c.click(),URL.revokeObjectURL(m)}catch(a){i.close(),alert("Erreur: "+a.message)}finally{e.disabled=!1,t.textContent="T\xE9l\xE9charger",s.classList.add("hidden"),setTimeout(()=>{this.elements.progressContainer&&this.elements.progressContainer.classList.add("hidden")},5e3)}}showLoading(e){e?this.elements.loading.classList.remove("hidden"):(this.elements.loading.classList.add("hidden"),this.elements.preview.classList.contains("hidden")&&this.elements.emptyState.classList.remove("hidden"))}}});var W,oe=I(()=>{W=class{constructor(){this.selectedFiles=[],this.results=[],this.selectedModel="u2net",this.isServerAvailable=!1,this.reconnectInterval=null,this.isProcessing=!1,this.elements={dropZone:document.getElementById("rembgDropZone"),fileInput:document.getElementById("rembgFileInput"),fileList:document.getElementById("rembgFileList"),modelOptions:document.querySelectorAll(".model-option"),processBtn:document.getElementById("rembgProcessBtn"),progressContainer:document.getElementById("rembgProgressContainer"),progressFill:document.getElementById("rembgProgressFill"),progressText:document.getElementById("rembgProgressText"),resultContainer:document.getElementById("rembgResultContainer"),downloadBtn:document.getElementById("rembgDownloadBtn"),newBtn:document.getElementById("rembgNewBtn"),statusBadge:document.getElementById("rembgStatusBadge"),serverError:document.getElementById("rembgServerError")},this.init()}async init(){await this.checkServer(),this.setupEventListeners()}async checkServer(){try{let t=await(await fetch("/api/rembg/health")).json();return this.isServerAvailable=t.available===!0,this.updateServerStatus(),this.isServerAvailable}catch{return this.isServerAvailable=!1,this.updateServerStatus(),!1}}startAutoReconnect(){this.reconnectInterval||(this.reconnectInterval=setInterval(async()=>{this.isServerAvailable?(clearInterval(this.reconnectInterval),this.reconnectInterval=null):await this.checkServer()&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null)},3e3))}updateServerStatus(){let e=this.elements.statusBadge,t=this.elements.serverError;this.isServerAvailable?(e.textContent="\u25CF Connect\xE9",e.classList.add("connected"),e.classList.remove("disconnected"),t.classList.add("hidden"),this.elements.dropZone.classList.remove("disabled")):(e.textContent="\u25CB D\xE9connect\xE9",e.classList.add("disconnected"),e.classList.remove("connected"),t.classList.remove("hidden"),this.elements.dropZone.classList.add("disabled"),this.startAutoReconnect())}setupEventListeners(){this.elements.dropZone.onclick=()=>{this.isServerAvailable&&!this.isProcessing&&this.elements.fileInput.click()},this.elements.fileInput.onchange=e=>{e.target.files.length>0&&(this.handleFiles(Array.from(e.target.files)),this.elements.fileInput.value="")},this.elements.dropZone.ondragover=e=>{e.preventDefault(),this.isServerAvailable&&!this.isProcessing&&this.elements.dropZone.classList.add("drag-over")},this.elements.dropZone.ondragleave=()=>{this.elements.dropZone.classList.remove("drag-over")},this.elements.dropZone.ondrop=e=>{e.preventDefault(),this.elements.dropZone.classList.remove("drag-over"),this.isServerAvailable&&!this.isProcessing&&e.dataTransfer.files.length&&this.handleFiles(Array.from(e.dataTransfer.files))},this.elements.processBtn.onclick=()=>this.processImages(),this.elements.newBtn.onclick=()=>this.reset(),this.elements.modelOptions.forEach(e=>{e.onclick=()=>{this.isProcessing||(this.elements.modelOptions.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.selectedModel=e.getAttribute("data-model"))}}),document.getElementById("rembgRetryBtn")?.addEventListener("click",()=>{this.checkServer()})}handleFiles(e){let t=["image/png","image/jpeg","image/jpg","image/webp","image/gif","image/bmp"];e.forEach(s=>{if(!t.includes(s.type)){console.warn(`Type de fichier non support\xE9: ${s.name}`);return}if(s.size>10*1024*1024){console.warn(`Fichier trop volumineux: ${s.name}`);return}this.selectedFiles.some(i=>i.name===s.name&&i.size===s.size)||this.selectedFiles.push({file:s,name:s.name,size:s.size,status:"pending",preview:URL.createObjectURL(s)})}),this.updateUI()}updateUI(){this.selectedFiles.length>0?(this.elements.dropZone.classList.add("hidden"),this.elements.fileList.classList.remove("hidden"),this.elements.processBtn.classList.remove("hidden"),this.renderFileList()):(this.elements.dropZone.classList.remove("hidden"),this.elements.fileList.classList.add("hidden"),this.elements.processBtn.classList.add("hidden"))}renderFileList(){this.elements.fileList.innerHTML="",this.selectedFiles.forEach((e,t)=>{let s=document.createElement("div");s.className=`rembg-file-item ${e.status}`,s.innerHTML=`
                <div class="rembg-preview">
                    <img src="${e.preview}" alt="Aper\xE7u">
                </div>
                <div class="file-details">
                    <h3>${e.name}</h3>
                    <p>${this.formatSize(e.size)}</p>
                    <div class="item-status">${this.getStatusText(e.status)}</div>
                </div>
                ${this.isProcessing?"":`
                    <button class="btn-remove-item" data-index="${t}">
                        <i data-lucide="trash-2"></i>
                    </button>
                `}
            `,this.elements.fileList.appendChild(s)}),window.lucide&&window.lucide.createIcons(),this.elements.fileList.querySelectorAll(".btn-remove-item").forEach(e=>{e.onclick=t=>{let s=parseInt(e.getAttribute("data-index"));this.removeFile(s)}})}getStatusText(e){switch(e){case"pending":return"En attente";case"processing":return"Traitement...";case"completed":return"Termin\xE9";case"error":return"Erreur";default:return""}}removeFile(e){let t=this.selectedFiles[e];t.preview&&URL.revokeObjectURL(t.preview),this.selectedFiles.splice(e,1),this.updateUI()}async processImages(){if(this.selectedFiles.length===0||this.isProcessing)return;this.isProcessing=!0,this.results=[],this.elements.processBtn.disabled=!0,this.elements.processBtn.classList.add("hidden"),this.elements.progressContainer.classList.remove("hidden");let e=this.selectedFiles.length;for(let t=0;t<this.selectedFiles.length;t++){let s=this.selectedFiles[t];s.status="processing",this.renderFileList(),this.elements.progressText.textContent=`Traitement de ${t+1}/${e} : ${s.name}`,this.updateProgress(t/e*100);try{let n=new FormData;n.append("file",s.file),n.append("model",this.selectedModel);let i=await fetch("/api/rembg/remove",{method:"POST",body:n});if(!i.ok){let l=await i.json();throw new Error(l.error||"Erreur lors du traitement")}let a=await i.blob(),o=URL.createObjectURL(a);s.status="completed",s.resultUrl=o,s.resultBlob=a,this.results.push({name:s.name,url:o,blob:a})}catch(n){console.error(`Error processing ${s.name}:`,n),s.status="error",s.error=n.message}}this.updateProgress(100),this.elements.progressText.textContent="Traitement termin\xE9 !",this.isProcessing=!1,setTimeout(()=>{this.showResults()},800)}updateProgress(e){this.elements.progressFill.style.width=`${e}%`}showResults(){this.elements.fileList.classList.add("hidden"),this.elements.progressContainer.classList.add("hidden"),this.elements.resultContainer.classList.remove("hidden");let e=document.createElement("div");e.className="results-grid",this.results.forEach((a,o)=>{let l=document.createElement("div");l.className="result-card",l.innerHTML=`
                <img src="${a.url}" alt="${a.name}">
                <h4>${a.name}</h4>
                <button class="btn-secondary btn-sm" onclick="window.downloadSingleResult(${o})">
                    <i data-lucide="download"></i> T\xE9l\xE9charger
                </button>
            `,e.appendChild(l)}),window.downloadSingleResult=a=>{let o=this.results[a],l=document.createElement("a");l.href=o.url,l.download=`nobg-${o.name.replace(/\.[^.]+$/,"")}.png`,l.click()};let t=this.elements.resultContainer;t.innerHTML="";let s=document.createElement("h3");s.textContent=`${this.results.length} image(s) trait\xE9e(s)`,s.style.marginBottom="24px",t.appendChild(s),t.appendChild(e);let n=document.createElement("div");if(n.className="result-actions",this.results.length>1){let a=document.createElement("button");a.className="btn-convert",a.innerHTML='<span class="btn-text"><i data-lucide="package"></i> Tout t\xE9l\xE9charger (ZIP)</span>',a.onclick=()=>this.downloadAllAsZip(),n.appendChild(a)}else if(this.results.length===1){let a=document.createElement("button");a.className="btn-convert",a.innerHTML='<span class="btn-text"><i data-lucide="download"></i> T\xE9l\xE9charger</span>',a.onclick=()=>window.downloadSingleResult(0),n.appendChild(a)}let i=document.createElement("button");i.className="btn-secondary",i.textContent="Nouvelles images",i.onclick=()=>this.reset(),n.appendChild(i),t.appendChild(n),window.lucide&&window.lucide.createIcons()}async downloadAllAsZip(){if(window.JSZip||typeof JSZip<"u"){let e=new JSZip;this.results.forEach(n=>{e.file(`nobg-${n.name.replace(/\.[^.]+$/,"")}.png`,n.blob)});let t=await e.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download="images-sans-fond.zip",s.click()}else for(let e=0;e<this.results.length;e++)window.downloadSingleResult(e),await new Promise(t=>setTimeout(t,300))}reset(){this.selectedFiles.forEach(e=>{e.preview&&URL.revokeObjectURL(e.preview)}),this.results.forEach(e=>{e.url&&URL.revokeObjectURL(e.url)}),this.selectedFiles=[],this.results=[],this.isProcessing=!1,this.elements.dropZone.classList.remove("hidden"),this.elements.fileList.classList.add("hidden"),this.elements.resultContainer.classList.add("hidden"),this.elements.progressContainer.classList.add("hidden"),this.elements.processBtn.classList.add("hidden"),this.elements.processBtn.disabled=!1,this.elements.fileInput.value="",this.elements.progressFill.style.width="0%"}formatSize(e){if(e===0)return"0 B";let t=1024,s=["B","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(2))+" "+s[n]}}});var Z,re=I(()=>{Z=class{constructor(){this.selectedFile=null,this.isServerAvailable=!1,this.reconnectInterval=null,this.availableModels=[],this.elements={dropZone:document.getElementById("sttDropZone"),fileInput:document.getElementById("sttFileInput"),fileInfo:document.getElementById("sttFileInfo"),fileName:document.getElementById("sttFileName"),fileSize:document.getElementById("sttFileSize"),fileDuration:document.getElementById("sttFileDuration"),removeBtn:document.getElementById("sttRemoveFile"),modelSelect:document.getElementById("sttModelSelect"),transcribeBtn:document.getElementById("sttTranscribeBtn"),progressContainer:document.getElementById("sttProgressContainer"),progressFill:document.getElementById("sttProgressFill"),progressText:document.getElementById("sttProgressText"),resultContainer:document.getElementById("sttResultContainer"),resultText:document.getElementById("sttResultText"),copyBtn:document.getElementById("sttCopyBtn"),downloadBtn:document.getElementById("sttDownloadBtn"),newBtn:document.getElementById("sttNewBtn"),statusBadge:document.getElementById("sttStatusBadge"),serverError:document.getElementById("sttServerError")},this.init()}async init(){await this.checkServer(),await this.loadModels(),this.setupEventListeners()}async checkServer(){try{let t=await(await fetch("/api/stt/health")).json();return this.isServerAvailable=t.available===!0,this.updateServerStatus(),this.isServerAvailable}catch{return this.isServerAvailable=!1,this.updateServerStatus(),!1}}startAutoReconnect(){this.reconnectInterval||(this.reconnectInterval=setInterval(async()=>{this.isServerAvailable?(clearInterval(this.reconnectInterval),this.reconnectInterval=null):await this.checkServer()&&(await this.loadModels(),clearInterval(this.reconnectInterval),this.reconnectInterval=null)},3e3))}async loadModels(){if(this.isServerAvailable)try{let t=await(await fetch("/api/stt/models")).json();this.availableModels=t.models||[],this.populateModelSelect(t.default||"base")}catch(e){console.error("Failed to load models:",e)}}populateModelSelect(e){let t=this.elements.modelSelect;t&&(t.innerHTML="",this.availableModels.forEach(s=>{let n=document.createElement("option");n.value=s.id,n.textContent=`${s.name} - ${s.description}`,n.selected=s.id===e,t.appendChild(n)}))}updateServerStatus(){let e=this.elements.statusBadge,t=this.elements.serverError;this.isServerAvailable?(e.textContent="\u25CF Connect\xE9",e.classList.add("connected"),e.classList.remove("disconnected"),t.classList.add("hidden"),this.elements.dropZone.classList.remove("disabled")):(e.textContent="\u25CB D\xE9connect\xE9",e.classList.add("disconnected"),e.classList.remove("connected"),t.classList.remove("hidden"),this.elements.dropZone.classList.add("disabled"),this.startAutoReconnect())}setupEventListeners(){this.elements.dropZone.onclick=()=>{this.isServerAvailable&&this.elements.fileInput.click()},this.elements.fileInput.onchange=e=>{e.target.files[0]&&this.handleFile(e.target.files[0])},this.elements.dropZone.ondragover=e=>{e.preventDefault(),this.isServerAvailable&&this.elements.dropZone.classList.add("drag-over")},this.elements.dropZone.ondragleave=()=>{this.elements.dropZone.classList.remove("drag-over")},this.elements.dropZone.ondrop=e=>{e.preventDefault(),this.elements.dropZone.classList.remove("drag-over"),this.isServerAvailable&&e.dataTransfer.files.length&&this.handleFile(e.dataTransfer.files[0])},this.elements.removeBtn.onclick=()=>this.reset(),this.elements.transcribeBtn.onclick=()=>this.transcribe(),this.elements.newBtn.onclick=()=>this.reset(),this.elements.copyBtn.onclick=()=>this.copyResult(),this.elements.downloadBtn.onclick=()=>this.downloadResult(),document.getElementById("sttRetryBtn")?.addEventListener("click",()=>{this.checkServer().then(()=>this.loadModels())})}handleFile(e){let t=["audio/mpeg","audio/mp3","audio/wav","audio/x-wav","audio/m4a","audio/x-m4a","audio/mp4","audio/ogg","audio/flac","audio/webm","video/webm","video/mp4"],s=["mp3","wav","m4a","ogg","flac","webm","mp4"],n=e.name.split(".").pop().toLowerCase();if(!t.includes(e.type)&&!s.includes(n)){alert("\u274C Type de fichier non support\xE9. Utilisez MP3, WAV, M4A, OGG, FLAC ou WebM.");return}if(e.size>500*1024*1024){alert("\u274C Fichier trop volumineux. Maximum: 500MB");return}this.selectedFile=e,this.elements.dropZone.classList.add("hidden"),this.elements.fileInfo.classList.remove("hidden"),this.elements.resultContainer.classList.add("hidden"),this.elements.transcribeBtn.classList.remove("hidden"),this.elements.fileName.textContent=e.name,this.elements.fileSize.textContent=this.formatSize(e.size),this.getAudioDuration(e)}getAudioDuration(e){let t=new Audio;t.src=URL.createObjectURL(e),t.onloadedmetadata=()=>{let s=this.formatDuration(t.duration);this.elements.fileDuration.textContent=s,URL.revokeObjectURL(t.src)},t.onerror=()=>{this.elements.fileDuration.textContent="--:--"}}formatDuration(e){let t=Math.floor(e/60),s=Math.floor(e%60);return`${t}:${s.toString().padStart(2,"0")}`}async transcribe(){if(!this.selectedFile)return;let e=this.elements.modelSelect.value;this.elements.transcribeBtn.disabled=!0,this.elements.progressContainer.classList.remove("hidden"),this.elements.progressText.textContent=`Transcription avec le mod\xE8le ${e}...`,this.animateProgress(0,90,3e4);let t=new FormData;t.append("file",this.selectedFile),t.append("model",e);try{let s=await fetch("/api/stt/transcribe",{method:"POST",body:t});if(!s.ok){let i=await s.json();throw new Error(i.error||"Erreur lors de la transcription")}let n=await s.json();this.animateProgress(90,100,300),setTimeout(()=>{this.showResult(n)},400)}catch(s){console.error("STT Error:",s),alert("\u{1F6A8} "+s.message),this.elements.progressContainer.classList.add("hidden"),this.elements.transcribeBtn.disabled=!1}}showResult(e){this.elements.fileInfo.classList.add("hidden"),this.elements.progressContainer.classList.add("hidden"),this.elements.transcribeBtn.classList.add("hidden"),this.elements.resultContainer.classList.remove("hidden"),this.elements.resultText.value=e.text||"",this.transcriptionResult=e}copyResult(){let e=this.elements.resultText.value;navigator.clipboard.writeText(e).then(()=>{let t=this.elements.copyBtn,s=t.innerHTML;t.innerHTML='<span class="btn-text">\u2713 Copi\xE9!</span>',setTimeout(()=>{t.innerHTML=s},2e3)})}downloadResult(){let e=this.elements.resultText.value,t=this.selectedFile?.name.replace(/\.[^.]+$/,"")||"transcription",s=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download=`${t}.txt`,i.click(),URL.revokeObjectURL(n)}animateProgress(e,t,s){let n=Date.now(),i=()=>{let a=Date.now()-n,o=Math.min(a/s,1),l=e+(t-e)*this.easeOutQuad(o);this.elements.progressFill.style.width=`${l}%`,o<1&&requestAnimationFrame(i)};i()}easeOutQuad(e){return e*(2-e)}reset(){this.selectedFile=null,this.transcriptionResult=null,this.elements.dropZone.classList.remove("hidden"),this.elements.fileInfo.classList.add("hidden"),this.elements.resultContainer.classList.add("hidden"),this.elements.progressContainer.classList.add("hidden"),this.elements.transcribeBtn.classList.add("hidden"),this.elements.transcribeBtn.disabled=!1,this.elements.fileInput.value="",this.elements.progressFill.style.width="0%"}formatSize(e){if(e===0)return"0 B";let t=1024,s=["B","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(2))+" "+s[n]}}});var J,le=I(()=>{J=class{constructor(){this.selectedFile=null,this.isServerAvailable=!1,this.reconnectInterval=null,this.selectedScale=4,this.denoise=!1,this.elements={dropZone:document.getElementById("upscaleDropZone"),fileInput:document.getElementById("upscaleFileInput"),fileInfo:document.getElementById("upscaleFileInfo"),preview:document.getElementById("upscalePreview"),fileName:document.getElementById("upscaleFileName"),fileSize:document.getElementById("upscaleFileSize"),removeBtn:document.getElementById("upscaleRemoveFile"),processBtn:document.getElementById("upscaleProcessBtn"),progressContainer:document.getElementById("upscaleProgressContainer"),progressFill:document.getElementById("upscaleProgressFill"),progressText:document.getElementById("upscaleProgressText"),resultContainer:document.getElementById("upscaleResultContainer"),resultImage:document.getElementById("upscaleResultImage"),downloadBtn:document.getElementById("upscaleDownloadBtn"),newBtn:document.getElementById("upscaleNewBtn"),statusBadge:document.getElementById("upscaleStatusBadge"),serverError:document.getElementById("upscaleServerError"),scaleBtns:document.querySelectorAll(".scale-toggle .toggle-btn"),denoiseBtns:document.querySelectorAll(".denoise-toggle .toggle-btn")},this.init()}async init(){await this.checkServer(),this.setupEventListeners()}async checkServer(){try{let t=await(await fetch("/api/upscale/health")).json();return this.isServerAvailable=t.available===!0,this.updateServerStatus(),this.isServerAvailable}catch{return this.isServerAvailable=!1,this.updateServerStatus(),!1}}startAutoReconnect(){this.reconnectInterval||(this.reconnectInterval=setInterval(async()=>{this.isServerAvailable?(clearInterval(this.reconnectInterval),this.reconnectInterval=null):await this.checkServer()&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null)},3e3))}updateServerStatus(){let e=this.elements.statusBadge,t=this.elements.serverError;this.isServerAvailable?(e.textContent="\u25CF Connect\xE9",e.classList.add("connected"),e.classList.remove("disconnected"),t.classList.add("hidden"),this.elements.dropZone.classList.remove("disabled")):(e.textContent="\u25CB D\xE9connect\xE9",e.classList.add("disconnected"),e.classList.remove("connected"),t.classList.remove("hidden"),this.elements.dropZone.classList.add("disabled"),this.startAutoReconnect())}setupEventListeners(){this.elements.dropZone.onclick=()=>{this.isServerAvailable&&this.elements.fileInput.click()},this.elements.fileInput.onchange=e=>{e.target.files[0]&&this.handleFile(e.target.files[0])},this.elements.scaleBtns.forEach(e=>{e.onclick=()=>{this.elements.scaleBtns.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.selectedScale=parseInt(e.dataset.scale)}}),this.elements.denoiseBtns.forEach(e=>{e.onclick=()=>{this.elements.denoiseBtns.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.denoise=e.dataset.denoise==="true"}}),this.elements.dropZone.ondragover=e=>{e.preventDefault(),this.isServerAvailable&&this.elements.dropZone.classList.add("drag-over")},this.elements.dropZone.ondragleave=()=>{this.elements.dropZone.classList.remove("drag-over")},this.elements.dropZone.ondrop=e=>{e.preventDefault(),this.elements.dropZone.classList.remove("drag-over"),this.isServerAvailable&&e.dataTransfer.files.length&&this.handleFile(e.dataTransfer.files[0])},this.elements.removeBtn.onclick=()=>this.reset(),this.elements.processBtn.onclick=()=>this.processImage(),this.elements.newBtn.onclick=()=>this.reset(),document.getElementById("upscaleRetryBtn")?.addEventListener("click",()=>{this.checkServer()})}handleFile(e){if(!["image/png","image/jpeg","image/jpg","image/webp","image/bmp"].includes(e.type)){alert("\u274C Type de fichier non support\xE9. Utilisez PNG, JPG, WEBP ou BMP.");return}if(e.size>10*1024*1024){alert("\u274C Fichier trop volumineux. Maximum: 10MB");return}this.selectedFile=e,this.elements.dropZone.classList.add("hidden"),this.elements.fileInfo.classList.remove("hidden"),this.elements.resultContainer.classList.add("hidden"),this.elements.processBtn.classList.remove("hidden"),this.elements.fileName.textContent=e.name,this.elements.fileSize.textContent=this.formatSize(e.size);let s=new FileReader;s.onload=n=>{this.elements.preview.src=n.target.result},s.readAsDataURL(e)}async processImage(){if(!this.selectedFile)return;this.elements.processBtn.disabled=!0,this.elements.progressContainer.classList.remove("hidden"),this.elements.progressText.textContent=`Agrandissement x${this.selectedScale} par l'IA...`,this.animateProgress(0,95,15e3);let e=new FormData;e.append("file",this.selectedFile),e.append("scale",this.selectedScale),e.append("denoise",this.denoise);try{let t=await fetch("/api/upscale/process",{method:"POST",body:e});if(!t.ok){let i=await t.json();throw new Error(i.error||"Erreur lors du traitement")}let s=await t.blob(),n=URL.createObjectURL(s);this.animateProgress(95,100,300),setTimeout(()=>{this.showResult(n,s)},400)}catch(t){console.error("Upscale Error:",t),alert("\u{1F6A8} "+t.message),this.elements.progressContainer.classList.add("hidden"),this.elements.processBtn.classList.remove("hidden"),this.elements.processBtn.disabled=!1}}showResult(e,t){this.elements.fileInfo.classList.add("hidden"),this.elements.progressContainer.classList.add("hidden"),this.elements.processBtn.classList.add("hidden"),this.elements.resultContainer.classList.remove("hidden"),this.elements.resultImage.src=e,this.elements.downloadBtn.onclick=()=>{let s=document.createElement("a");s.href=e,s.download=`upscaled-${this.selectedFile.name.replace(/\.[^.]+$/,"")}.png`,s.click()}}animateProgress(e,t,s){this._progressInterval&&clearInterval(this._progressInterval);let n=Date.now();this._progressInterval=setInterval(()=>{let i=Date.now()-n,a=Math.min(i/s,1),o=e+(t-e)*this.easeOutQuad(a);this.elements.progressFill.style.width=`${o}%`,a>=1&&clearInterval(this._progressInterval)},50)}easeOutQuad(e){return e*(2-e)}reset(){this._progressInterval&&clearInterval(this._progressInterval),this.selectedFile=null,this.elements.dropZone.classList.remove("hidden"),this.elements.fileInfo.classList.add("hidden"),this.elements.resultContainer.classList.add("hidden"),this.elements.progressContainer.classList.add("hidden"),this.elements.processBtn.classList.add("hidden"),this.elements.processBtn.disabled=!1,this.elements.fileInput.value="",this.elements.progressFill.style.width="0%"}formatSize(e){if(e===0)return"0 B";let t=1024,s=["B","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(2))+" "+s[n]}}});var u,_=I(()=>{u=class{static async get(e,t=null){try{let i=await(await fetch(`/api/settings/${e}`)).json();if(i.value!==null&&i.value!==void 0)return i.value}catch(n){console.warn(`Error fetching setting ${e}:`,n)}let s=localStorage.getItem(e);if(s!==null)try{return JSON.parse(s)}catch{return s}return t}static async set(e,t){localStorage.setItem(e,typeof t=="object"?JSON.stringify(t):t);try{await fetch("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:e,value:t})})}catch(s){console.error(`Error saving setting ${e}:`,s)}}static async migrate(){let e={};for(let t=0;t<localStorage.length;t++){let s=localStorage.key(t);if(s.startsWith("ultra-")){let n=localStorage.getItem(s);try{n=JSON.parse(n)}catch{}e[s]=n}}if(Object.keys(e).length!==0)try{(await fetch("/api/settings/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({settings:e})})).ok&&console.log("\u2705 Migration to SQLite successful")}catch(t){console.error("Migration failed:",t)}}static async getAll(){try{return await(await fetch("/api/settings")).json()}catch(e){return console.error("Error fetching all settings:",e),{}}}}});var Q,ce=I(()=>{_();Q=class{constructor(){this.themeToggle=document.getElementById("themeToggle"),this.reduceMotionToggle=document.getElementById("reduceMotionToggle"),this.compactSidebarToggle=document.getElementById("compactSidebarToggle"),this.soundToggle=document.getElementById("soundToggle"),this.clearCacheBtn=document.getElementById("clearCacheBtn"),this.accentPicker=document.getElementById("accentPicker"),this.accentDots=document.querySelectorAll(".accent-dot"),this.sidebarItemCheckboxes=document.querySelectorAll("[data-sidebar-item]"),this.settingsTabLinks=document.querySelectorAll(".settings-tab-link"),this.settingsTabPanes=document.querySelectorAll(".settings-tab-pane"),this.plexusSourceCount=document.getElementById("plexusSourceCount"),this.plexusExtraInfo=document.getElementById("plexusExtraInfo"),this.pinItemBtns=document.querySelectorAll(".pin-item-btn"),this.pinnedItemsContainer=document.getElementById("pinnedItemsContainer"),this.init()}async init(){await u.migrate(),await this.loadSettings(),this.themeToggle&&this.themeToggle.addEventListener("change",()=>this.toggleTheme()),this.reduceMotionToggle&&this.reduceMotionToggle.addEventListener("change",()=>this.toggleReduceMotion()),this.compactSidebarToggle&&this.compactSidebarToggle.addEventListener("change",()=>this.toggleCompactSidebar()),this.clearCacheBtn&&this.clearCacheBtn.addEventListener("click",()=>this.clearCache()),this.accentDots&&this.accentDots.forEach(e=>{e.addEventListener("click",()=>this.setAccentColor(e.dataset.color,e))}),this.sidebarItemCheckboxes&&this.sidebarItemCheckboxes.forEach(e=>{e.addEventListener("change",()=>this.toggleSidebarItem(e))}),this.settingsTabLinks&&this.settingsTabLinks.forEach(e=>{e.addEventListener("click",()=>this.switchSettingsTab(e.dataset.settingsTab))}),this.plexusSourceCount&&this.plexusSourceCount.addEventListener("input",()=>this.savePlexusSettings()),this.plexusExtraInfo&&this.plexusExtraInfo.addEventListener("input",()=>this.savePlexusSettings()),this.pinItemBtns&&this.pinItemBtns.forEach(e=>{e.addEventListener("click",()=>this.togglePinItem(e))}),await this.updatePinnedSidebar()}async loadSettings(){let e=await u.get("ultra-theme","dark");document.documentElement.setAttribute("data-theme",e),this.themeToggle&&(this.themeToggle.checked=e==="dark");let t=await u.get("ultra-reduce-motion",!1);document.body.classList.toggle("reduce-motion",t),this.reduceMotionToggle&&(this.reduceMotionToggle.checked=t);let s=await u.get("ultra-compact-sidebar",!1);document.body.classList.toggle("compact-sidebar",s),this.compactSidebarToggle&&(this.compactSidebarToggle.checked=s);let n=await u.get("ultra-sound",!0);this.soundToggle&&(this.soundToggle.checked=n);let i=await u.get("ultra-accent-color","#ffffff");this.applyAccentColor(i),this.accentDots.forEach(l=>{l.classList.toggle("active",l.dataset.color===i)}),await this.loadSidebarItemsVisibility();let a=await u.get("ultra-plexus-source-count",3),o=await u.get("ultra-plexus-extra-info","");this.plexusSourceCount&&(this.plexusSourceCount.value=a),this.plexusExtraInfo&&(this.plexusExtraInfo.value=o)}switchSettingsTab(e){this.settingsTabLinks.forEach(t=>{t.classList.toggle("active",t.dataset.settingsTab===e)}),this.settingsTabPanes.forEach(t=>{t.classList.toggle("active",t.id===`settings-${e}`)})}async savePlexusSettings(){this.plexusSourceCount&&await u.set("ultra-plexus-source-count",parseInt(this.plexusSourceCount.value)||3),this.plexusExtraInfo&&await u.set("ultra-plexus-extra-info",this.plexusExtraInfo.value)}async loadSidebarItemsVisibility(){let e=await u.get("ultra-hidden-sidebar-items",[]);this.sidebarItemCheckboxes.forEach(t=>{let s=t.dataset.sidebarItem,n=e.includes(s);t.checked=!n,this.updateSidebarItemVisibility(s,!n)})}updateSidebarItemVisibility(e,t){let s=document.querySelector(`.nav-item[data-tab="${e}"]`);s&&(t?s.classList.remove("hidden-by-settings"):s.classList.add("hidden-by-settings"))}async toggleSidebarItem(e){let t=e.dataset.sidebarItem,s=e.checked;this.updateSidebarItemVisibility(t,s);let n=await u.get("ultra-hidden-sidebar-items",[]);if(s){let i=n.indexOf(t);i>-1&&n.splice(i,1)}else n.includes(t)||n.push(t);await u.set("ultra-hidden-sidebar-items",n),await this.updatePinnedSidebar()}async togglePinItem(e){let t=e.dataset.pinItem,s=await u.get("ultra-pinned-sidebar-items",[]),n=s.indexOf(t);n>-1?(s.splice(n,1),e.classList.remove("active")):(s.push(t),e.classList.add("active")),await u.set("ultra-pinned-sidebar-items",s),await this.updatePinnedSidebar()}async updatePinnedSidebar(){if(!this.pinnedItemsContainer)return;let e=await u.get("ultra-pinned-sidebar-items",[]),t=await u.get("ultra-hidden-sidebar-items",[]);this.pinItemBtns&&this.pinItemBtns.forEach(n=>{let i=n.dataset.pinItem;n.classList.toggle("active",e.includes(i))}),this.pinnedItemsContainer.innerHTML="";let s=e.filter(n=>!t.includes(n));if(s.length===0){this.pinnedItemsContainer.style.display="none";return}this.pinnedItemsContainer.style.display="flex",s.forEach(n=>{let i=document.querySelector(`.nav-section .nav-item[data-tab="${n}"]`);if(i){let a=i.querySelector(".nav-icon").innerHTML,o=i.querySelector(".nav-label").textContent,l=document.createElement("button");l.className="nav-item pinned-nav-item",l.dataset.tab=n,l.innerHTML=`
                    <span class="nav-icon">${a}</span>
                    <span class="nav-label">${o}</span>
                `,l.addEventListener("click",()=>{let m=new CustomEvent("switch-tab",{detail:{tab:n}});document.dispatchEvent(m)}),this.pinnedItemsContainer.appendChild(l)}}),window.lucide&&window.lucide.createIcons()}async toggleTheme(){let t=this.themeToggle.checked?"dark":"light";document.documentElement.setAttribute("data-theme",t),await u.set("ultra-theme",t)}async toggleReduceMotion(){let e=this.reduceMotionToggle.checked;document.body.classList.toggle("reduce-motion",e),await u.set("ultra-reduce-motion",e)}async toggleCompactSidebar(){let e=this.compactSidebarToggle.checked;document.body.classList.toggle("compact-sidebar",e),await u.set("ultra-compact-sidebar",e)}async setAccentColor(e,t){this.accentDots.forEach(s=>s.classList.remove("active")),t.classList.add("active"),this.applyAccentColor(e),await u.set("ultra-accent-color",e)}applyAccentColor(e){document.documentElement.style.setProperty("--accent",e),e==="#ffffff"?(document.documentElement.style.setProperty("--accent-hover","#f4f4f5"),document.documentElement.style.setProperty("--accent-dim","#27272a")):(document.documentElement.style.setProperty("--accent-hover",e+"ee"),document.documentElement.style.setProperty("--accent-dim",e+"22"))}async clearCache(){confirm("Voulez-vous vraiment vider le cache local ? Cela r\xE9initialisera \xE9galement vos r\xE9glages.")&&(localStorage.clear(),window.location.reload())}}});var de,me=I(()=>{de=()=>{let r=document.getElementById("chatForm"),e=document.getElementById("chatInput"),t=document.getElementById("chatMessages"),s=document.getElementById("pdfInput"),n=document.getElementById("pdfStatusText"),i=document.getElementById("pdfInfo"),a=document.getElementById("currentPdfName"),o=document.getElementById("currentPdfPages"),l=document.getElementById("removePdf"),m=document.getElementById("chatClearBtn"),c=document.querySelector(".model-badge"),d=[],f=null,E=async()=>{try{let b=await(await fetch("/api/chat/config")).json();if(b.model&&c){let y=b.model.split("/"),L=y[y.length-1].toUpperCase();c.textContent=L,c.title=b.model}}catch(p){console.error("Impossible de charger la config du chat",p)}},w=(p,b)=>{let y=document.createElement("div");y.className=`message ${p}`;let L=document.createElement("div");L.className="message-content",p!=="system"&&window.marked?L.innerHTML=marked.parse(b):L.textContent=b,y.appendChild(L),t.appendChild(y),t.scrollTop=t.scrollHeight},T=p=>{let b=document.querySelector(".typing-indicator");if(p&&!b){let y=document.createElement("div");y.className="typing-indicator",y.innerHTML='Ultra AI r\xE9fl\xE9chit <span class="dot"></span><span class="dot"></span><span class="dot"></span>',t.appendChild(y),t.scrollTop=t.scrollHeight}else!p&&b&&b.remove()};s.addEventListener("change",async p=>{let b=p.target.files[0];if(!b)return;n.textContent="Analyse en cours...";let y=new FormData;y.append("pdf",b);try{let L=await fetch("/api/chat/upload-pdf",{method:"POST",body:y});if(!L.ok)throw new Error("Erreur d'analyse");let $=await L.json();f=$.text,i.classList.remove("hidden"),a.textContent=$.filename,o.textContent=`${$.pages} pages`,n.textContent="PDF charg\xE9",w("system",`Document "${$.filename}" charg\xE9. Je peux maintenant r\xE9pondre \xE0 vos questions sur son contenu.`)}catch(L){console.error(L),n.textContent="Erreur de chargement",alert("Erreur lors de l'upload du PDF. Assurez-vous qu'il est valide.")}}),l.addEventListener("click",()=>{f=null,s.value="",i.classList.add("hidden"),n.textContent="Ajouter un PDF",w("system","Le contexte du document a \xE9t\xE9 retir\xE9.")});let v=async()=>{let p=e.value.trim();if(p){e.value="",e.style.height="auto",w("user",p),T(!0);try{let y=await(await fetch("/api/chat/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:p,history:d,context:f})})).json();T(!1),y.error?w("system",`Erreur: ${y.error}`):(w("ai",y.reply),d=y.history)}catch(b){T(!1),w("system","Erreur de connexion avec le serveur."),console.error(b)}}};r.addEventListener("submit",p=>{p.preventDefault(),v()}),e.addEventListener("keydown",p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),v())}),e.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),m.addEventListener("click",()=>{confirm("Voulez-vous vraiment effacer l'historique de la conversation ?")&&(d=[],t.innerHTML=`
                <div class="message system">
                    <div class="message-content">
                        Historique effac\xE9. Je suis pr\xEAt pour une nouvelle discussion !
                    </div>
                </div>
            `)}),E()}});function he(){Pe(),Ae(),Fe(),De(),$e(),He()}function $e(){let r=document.getElementById("cur-from-val"),e=document.getElementById("cur-to-val"),t=document.getElementById("cur-from-type"),s=document.getElementById("cur-to-type"),n=document.getElementById("cur-swap"),i=document.getElementById("cur-rate-info");if(!r)return;let a=async()=>{let l=parseFloat(r.value);if(isNaN(l)||l<=0){e.value="";return}let m=t.value,c=s.value;if(m===c){e.value=l.toFixed(2),i.textContent=`1 ${m} = 1.00 ${c}`;return}try{i.textContent="Mise \xE0 jour du taux...";let f=await(await fetch(`https://api.frankfurter.app/latest?amount=${l}&from=${m}&to=${c}`)).json();if(f.rates&&f.rates[c]){let E=f.rates[c];e.value=E.toFixed(2);let w=E/l;i.textContent=`1 ${m} = ${w.toFixed(4)} ${c}`}}catch(d){console.error("Currency API error:",d),i.textContent="Erreur lors de la r\xE9cup\xE9ration du taux"}},o=null;r.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(a,500)}),[t,s].forEach(l=>l.addEventListener("change",a)),n.addEventListener("click",()=>{let l=t.value;t.value=s.value,s.value=l,a()}),a()}function Pe(){let r=document.getElementById("qr-input"),e=document.getElementById("qrcode-result"),t=document.getElementById("qr-download");if(!r||!e)return;let s=null;r.addEventListener("input",()=>{clearTimeout(s);let n=r.value.trim();if(!n){e.innerHTML='<p style="color: var(--text-muted); font-size: 12px;">Votre QR code appara\xEEtra ici</p>',t.classList.add("hidden");return}s=setTimeout(()=>{e.innerHTML="",QRCode.toCanvas(n,{width:200,margin:2,color:{dark:"#000000",light:"#ffffff"}},(i,a)=>{if(i){console.error(i),e.innerHTML='<p style="color: #ef4444; font-size: 12px;">Erreur de g\xE9n\xE9ration</p>';return}e.appendChild(a),t.classList.remove("hidden")})},300)}),t.addEventListener("click",()=>{let n=e.querySelector("canvas");if(!n)return;let i=document.createElement("a");i.download="qrcode.png",i.href=n.toDataURL(),i.click()})}function Ae(){let r=document.getElementById("pass-length"),e=document.getElementById("pass-length-val"),t=document.getElementById("pass-result"),s=document.getElementById("pass-gen"),n=document.getElementById("pass-copy"),i=document.getElementById("pass-upper"),a=document.getElementById("pass-lower"),o=document.getElementById("pass-num"),l=document.getElementById("pass-sym");if(!r||!s)return;r.addEventListener("input",()=>{e.textContent=r.value});let m=()=>{let c=parseInt(r.value),d={upper:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",lower:"abcdefghijklmnopqrstuvwxyz",num:"0123456789",sym:"!@#$%^&*()_+~`|}{[]:;?><,./-="},f="";i.checked&&(f+=d.upper),a.checked&&(f+=d.lower),o.checked&&(f+=d.num),l.checked&&(f+=d.sym),f||(f=d.lower);let E="";for(let w=0;w<c;w++)E+=f.charAt(Math.floor(Math.random()*f.length));t.textContent=E};s.addEventListener("click",m),n.addEventListener("click",()=>{let c=t.textContent;c!=="********"&&navigator.clipboard.writeText(c).then(()=>{let d=n.innerHTML;n.innerHTML='<i data-lucide="check" style="width: 16px; height: 16px; color: var(--success);"></i>',window.lucide&&window.lucide.createIcons(),setTimeout(()=>{n.innerHTML=d,window.lucide&&window.lucide.createIcons()},2e3)})})}function Fe(){let r=document.getElementById("text-input"),e=document.getElementById("text-count-chars"),t=document.getElementById("text-count-words"),s=document.querySelectorAll("[data-action]");r&&(r.addEventListener("input",()=>{let n=r.value;e.textContent=`${n.length} caract\xE8res`;let i=n.trim()?n.trim().split(/\s+/).length:0;t.textContent=`${i} mots`}),s.forEach(n=>{n.closest(".tool-card").querySelector(".tool-title").textContent==="Outils Texte"&&n.addEventListener("click",()=>{let i=n.dataset.action,a=r.value;switch(i){case"upper":a=a.toUpperCase();break;case"lower":a=a.toLowerCase();break;case"title":a=a.toLowerCase().split(" ").map(o=>o.charAt(0).toUpperCase()+o.substring(1)).join(" ");break;case"clean":a=a.trim().replace(/\s+/g," ");break}r.value=a,r.dispatchEvent(new Event("input"))})}))}function De(){let r=document.getElementById("unit-from-val"),e=document.getElementById("unit-to-val"),t=document.getElementById("unit-type"),s=document.getElementById("unit-swap");if(!r||!e)return;let n=()=>{let i=parseFloat(r.value);if(isNaN(i)){e.value="";return}let a=t.value,o;switch(a){case"length":o=i*3.28084;break;case"weight":o=i*2.20462;break;case"temp":o=i*9/5+32;break}e.value=o.toFixed(2)};r.addEventListener("input",n),t.addEventListener("change",n),s.addEventListener("click",()=>{let i=t.value,a=parseFloat(r.value);e.value&&(r.value=e.value,n())})}function He(){let r=document.getElementById("mirrorVideo"),e=document.getElementById("mirrorCanvas"),t=document.getElementById("mirrorPlaceholder"),s=document.getElementById("mirrorToggle"),n=document.getElementById("mirrorCapture"),i=document.getElementById("mirrorDownload"),a=document.getElementById("mirrorDeviceSelect");if(!r||!s)return;let o=null,l=!1,m=[];async function c(){try{m=(await navigator.mediaDevices.enumerateDevices()).filter(p=>p.kind==="videoinput"),m.length>1&&(a.innerHTML='<option value="">S\xE9lectionner une cam\xE9ra...</option>',m.forEach((p,b)=>{let y=document.createElement("option");y.value=p.deviceId,y.textContent=p.label||`Cam\xE9ra ${b+1}`,a.appendChild(y)}),a.style.display="block")}catch(v){console.error("Error enumerating devices:",v)}}async function d(v=null){try{let p={video:v?{deviceId:{exact:v}}:!0,audio:!1};o=await navigator.mediaDevices.getUserMedia(p),r.srcObject=o,r.style.display="block",t.style.display="none",n.style.display="block",s.innerHTML='<i data-lucide="video-off" style="width: 14px; height: 14px;"></i> D\xE9sactiver',window.lucide&&window.lucide.createIcons(),l=!0,await c()}catch(p){console.error("Error accessing webcam:",p),alert("Impossible d'acc\xE9der \xE0 la webcam. V\xE9rifiez les permissions.")}}function f(){o&&(o.getTracks().forEach(v=>v.stop()),o=null),r.style.display="none",e.style.display="none",t.style.display="flex",n.style.display="none",i.style.display="none",s.innerHTML='<i data-lucide="video" style="width: 14px; height: 14px;"></i> Activer',window.lucide&&window.lucide.createIcons(),l=!1}function E(){if(!l)return;let v=e.getContext("2d");e.width=r.videoWidth,e.height=r.videoHeight,v.drawImage(r,0,0,e.width,e.height),r.style.display="none",e.style.display="block",i.style.display="block",n.innerHTML='<i data-lucide="rotate-ccw" style="width: 14px; height: 14px;"></i> Retour',window.lucide&&window.lucide.createIcons()}function w(){r.style.display="block",e.style.display="none",i.style.display="none",n.innerHTML='<i data-lucide="camera" style="width: 14px; height: 14px;"></i> Capturer',window.lucide&&window.lucide.createIcons()}function T(){let v=document.createElement("a"),p=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);v.download=`webcam-capture-${p}.png`,v.href=e.toDataURL("image/png"),v.click()}s.addEventListener("click",()=>{l?f():d()}),n.addEventListener("click",()=>{e.style.display==="block"?w():E()}),i.addEventListener("click",T),a.addEventListener("change",v=>{v.target.value&&l&&(f(),d(v.target.value))})}var ue=I(()=>{});var V,pe=I(()=>{V=class{constructor(){this.dirPathInput=document.getElementById("metaDirPath"),this.scanBtn=document.getElementById("metaScanBtn"),this.folderInput=document.getElementById("metaFolderInput"),this.metadataBody=document.getElementById("metadataBody"),this.emptyState=document.getElementById("metaEmptyState"),this.loadingOverlay=document.getElementById("metaLoading"),this.toolbar=document.getElementById("metaToolbar"),this.statusText=document.getElementById("metaStatusText"),this.applyAllBtn=document.getElementById("metaApplyAllBtn"),this.magicBtn=document.getElementById("metaMagicBtn"),this.searchSelector=document.getElementById("metaSearch"),this.files=[],this.filteredFiles=[],this.modifiedIndices=new Set,this.init()}init(){this.scanBtn&&(this.folderInput.addEventListener("change",e=>this.handleFolderSelect(e)),this.scanBtn.addEventListener("click",()=>this.scanDirectory()),this.applyAllBtn.addEventListener("click",()=>this.applyAllChanges()),this.magicBtn.addEventListener("click",()=>this.magicAutoTag()),this.searchSelector.addEventListener("input",e=>this.filterFiles(e.target.value)),this.dirPathInput.addEventListener("keypress",e=>{e.key==="Enter"&&this.scanDirectory()}))}handleFolderSelect(e){let t=e.target.files;if(t.length>0){let s=t[0].webkitRelativePath.split("/")[0];this.dirPathInput.value=`Dossier s\xE9lectionn\xE9: ${s} (${t.length} fichiers)`,this.processFilesFromBrowser(t)}}async processFilesFromBrowser(e){this.setLoading(!0),this.metadataBody.innerHTML="",this.files=[],this.modifiedIndices.clear();let t=[".mp3",".flac",".m4a",".wav",".ogg"],s=[".jpg",".jpeg",".png",".webp"];for(let n of e){let i="."+n.name.split(".").pop().toLowerCase();t.includes(i)?this.files.push({type:"audio",fileName:n.name,filePath:n.webkitRelativePath,title:n.name.replace(/\.[^/.]+$/,""),artist:"",album:"",genre:"",year:"",track:"",format:i.substring(1).toUpperCase(),browserFile:n}):s.includes(i)&&this.files.push({type:"image",fileName:n.name,filePath:n.webkitRelativePath,title:n.name,format:i.substring(1).toUpperCase(),browserFile:n})}this.filteredFiles=[...this.files],this.renderTable(),this.updateToolbar(),this.setLoading(!1)}async scanDirectory(){if(this.metadataBody.innerHTML="",this.filteredFiles.length===0){this.emptyState.classList.remove("hidden"),this.toolbar.classList.add("hidden");return}this.emptyState.classList.add("hidden"),this.toolbar.classList.remove("hidden"),this.renderTable(),this.updateToolbar()}renderTable(){if(this.metadataBody.innerHTML="",this.filteredFiles.length===0){this.emptyState.classList.remove("hidden"),this.toolbar.classList.add("hidden");return}this.emptyState.classList.add("hidden"),this.toolbar.classList.remove("hidden"),this.filteredFiles.forEach((e,t)=>{let s=document.createElement("tr");this.modifiedIndices.has(t)&&s.classList.add("modified"),s.innerHTML=`
                <td class="col-type"><span class="badge-type badge-${e.type}">${e.type}</span></td>
                <td class="col-filename" title="${e.fileName}">${e.fileName}</td>
                <td class="col-title"><div class="editable-cell" contenteditable="true" data-field="title" data-index="${t}">${e.title||""}</div></td>
                <td class="col-artist"><div class="editable-cell" contenteditable="true" data-field="artist" data-index="${t}">${e.artist||""}</div></td>
                <td class="col-album"><div class="editable-cell" contenteditable="true" data-field="album" data-index="${t}">${e.album||""}</div></td>
                <td class="col-genre"><div class="editable-cell" contenteditable="true" data-field="genre" data-index="${t}">${e.genre||""}</div></td>
                <td class="col-year"><div class="editable-cell" contenteditable="true" data-field="year" data-index="${t}">${e.year||""}</div></td>
                <td class="col-track"><div class="editable-cell" contenteditable="true" data-field="track" data-index="${t}">${e.track||""}</div></td>
                <td class="col-actions">
                    <button class="btn-icon-small" title="Aper\xE7u"><i data-lucide="eye" style="width: 14px; height: 14px;"></i></button>
                </td>
            `,s.querySelectorAll(".editable-cell").forEach(i=>{i.addEventListener("input",a=>{let o=a.target.dataset.field,l=parseInt(a.target.dataset.index),m=a.target.innerText.trim();this.files[l][o]=m,this.modifiedIndices.add(l),s.classList.add("modified"),this.updateToolbar()})}),this.metadataBody.appendChild(s)}),window.lucide&&window.lucide.createIcons()}filterFiles(e){let t=e.toLowerCase();this.filteredFiles=this.files.filter(s=>s.fileName.toLowerCase().includes(t)||s.title&&s.title.toLowerCase().includes(t)||s.artist&&s.artist.toLowerCase().includes(t)||s.album&&s.album.toLowerCase().includes(t)),this.renderTable()}updateToolbar(){let e=this.modifiedIndices.size;this.statusText=document.getElementById("metaStatusText"),this.statusText.innerText=`${this.files.length} fichiers charg\xE9s | ${e} modifi\xE9s`,e>0?this.applyAllBtn.classList.remove("hidden"):this.applyAllBtn.classList.add("hidden"),this.files.length>0?this.magicBtn.classList.remove("hidden"):this.magicBtn.classList.add("hidden")}magicAutoTag(){this.files.length!==0&&(this.files.forEach((e,t)=>{let s=e.fileName.replace(/\.[^/.]+$/,"");if(s.includes(" - ")){let n=s.split(" - ");n.length>=2&&(e.artist=n[0].trim(),e.title=n[1].trim(),this.modifiedIndices.add(t))}else e.title=s.replace(/[_-]/g," ").trim(),this.modifiedIndices.add(t)}),this.renderTable(),this.updateToolbar())}async applyAllChanges(){if(this.modifiedIndices.size===0)return;let e=`Voulez-vous appliquer les modifications \xE0 ${this.modifiedIndices.size} fichiers ?`;if(!confirm(e))return;this.setApplyLoading(!0);let t=Array.from(this.modifiedIndices),s=0;for(let n of t){let i=this.files[n];try{(await(await fetch("/api/metadata/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:i.filePath,metadata:{title:i.title,artist:i.artist,album:i.album,genre:i.genre,year:i.year,track:i.track}})})).json()).success&&s++}catch(a){console.error(`Error updating ${i.fileName}:`,a)}}this.setApplyLoading(!1),alert(`${s} fichiers mis \xE0 jour avec succ\xE8s !`),this.modifiedIndices.clear(),this.renderTable(),this.updateToolbar()}setLoading(e){e?this.loadingOverlay.classList.remove("hidden"):this.loadingOverlay.classList.add("hidden")}setApplyLoading(e){let t=this.applyAllBtn.querySelector(".btn-text"),s=this.applyAllBtn.querySelector(".btn-loader");e?(t.innerText="Application...",s.classList.remove("hidden"),this.applyAllBtn.disabled=!0):(t.innerHTML='<i data-lucide="save" class="inline-icon"></i> Appliquer les modifications',s.classList.add("hidden"),this.applyAllBtn.disabled=!1),window.lucide&&window.lucide.createIcons()}}});var G,ge=I(()=>{F();G=class{constructor(){this.dom={tab:document.getElementById("tab-torrent"),status:document.getElementById("torrentConnectionStatus"),loginOverlay:document.getElementById("torrentLoginOverlay"),user:document.getElementById("qbitUser"),pass:document.getElementById("qbitPass"),loginBtn:document.getElementById("qbitLoginBtn"),listBody:document.getElementById("torrentListBody"),addBtn:document.getElementById("torrentAddBtn"),magnetBtn:document.getElementById("torrentMagnetBtn"),fileInput:document.getElementById("torrentFileInput"),addModal:document.getElementById("addTorrentModal"),addOverlay:document.getElementById("addTorrentOverlay"),closeAddModal:document.getElementById("closeAddModal"),magnetInput:document.getElementById("magnetInput"),submitAdd:document.getElementById("submitAddTorrent"),pasteBtn:document.getElementById("pasteMagnetBtn"),totalDl:document.getElementById("totalDlSpeed"),totalUl:document.getElementById("totalUlSpeed"),pauseAll:document.getElementById("torrentPauseAllBtn"),resumeAll:document.getElementById("torrentResumeAllBtn")},this.pollingInterval=null,this.cache=new Map,this.init()}init(){this.dom.tab&&(this.dom.loginBtn.addEventListener("click",()=>this.login()),this.dom.addBtn.addEventListener("click",()=>this.dom.fileInput.click()),this.dom.fileInput.addEventListener("change",e=>this.handleFileSelect(e)),this.dom.magnetBtn.addEventListener("click",()=>this.showAddModal()),this.dom.closeAddModal.addEventListener("click",()=>this.hideAddModal()),this.dom.addOverlay.addEventListener("click",()=>this.hideAddModal()),this.dom.submitAdd.addEventListener("click",()=>this.addTorrent()),this.dom.pasteBtn.addEventListener("click",async()=>{try{let e=await navigator.clipboard.readText();this.dom.magnetInput.value=e}catch(e){console.error("Failed to read clipboard",e)}}),this.dom.pauseAll.addEventListener("click",()=>this.globalAction("pause")),this.dom.resumeAll.addEventListener("click",()=>this.globalAction("resume")),this.startPolling())}startPolling(){this.pollingInterval=setInterval(()=>{this.dom.tab.classList.contains("active")&&this.fetchData()},2e3),setTimeout(()=>{this.dom.tab.classList.contains("active")&&this.fetchData()},500)}async login(){try{let e=this.dom.user.value,t=this.dom.pass.value;(await(await fetch("/api/torrent/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})})).json()).success?(this.dom.loginOverlay.classList.add("hidden"),this.fetchData()):alert("Login failed")}catch(e){console.error(e),alert("Login error")}}async fetchData(){try{let e=await fetch("/api/torrent/list");if(e.status===403||e.status===401){this.dom.loginOverlay.classList.remove("hidden"),this.updateStatus(!1);return}let t=await e.json();this.dom.loginOverlay.classList.add("hidden"),this.updateStatus(!0),this.render(t)}catch(e){console.error("Fetch error:",e),this.updateStatus(!1)}}updateStatus(e){e?(this.dom.status.innerHTML='<i data-lucide="check-circle" class="status-icon"></i> CONNECT\xC9',this.dom.status.className="status-badge connected"):(this.dom.status.innerHTML='<i data-lucide="power" class="status-icon"></i> D\xC9CONNECT\xC9',this.dom.status.className="status-badge disconnected"),x()}visibleTorrents=new Set;render(e){if(!Array.isArray(e)){console.error("Expected array of torrents, got:",e);return}let t=0,s=0,n=new Set;e.forEach(i=>{t+=i.dlspeed,s+=i.upspeed,n.add(i.hash);let a=this.cache.get(i.hash);a||(a=this.createRow(i),this.dom.listBody.appendChild(a),this.cache.set(i.hash,a)),this.updateRow(a,i)});for(let[i,a]of this.cache)n.has(i)||(a.remove(),this.cache.delete(i));this.dom.totalDl.textContent=M(t),this.dom.totalUl.textContent=M(s),x()}createRow(e){let t=document.createElement("div");return t.className="torrent-item",t.innerHTML=`
            <div class="torrent-icon"><i data-lucide="package"></i></div>
            <div class="torrent-name-col">
                <div class="torrent-name" title="${e.name}">${e.name}</div>
                <div class="torrent-meta">
                    <span class="meta-peers"><i data-lucide="users" class="inline-icon"></i> ${e.num_leechs}/${e.num_seeds}</span>
                    <span class="meta-eta"><i data-lucide="clock" class="inline-icon"></i> ${ee(e.eta)}</span>
                </div>
            </div>
            <div class="size-col">${P(e.total_size)}</div>
            <div class="progress-col">
                <div class="progress-track">
                    <div class="progress-fill" style="width: ${e.progress*100}%"></div>
                </div>
                <div class="progress-text">${(e.progress*100).toFixed(1)}%</div>
            </div>
            <div class="speed-col">
                <div class="speed-down"><i data-lucide="arrow-down" class="inline-icon"></i> ${M(e.dlspeed)}</div>
                <div class="speed-up"><i data-lucide="arrow-up" class="inline-icon"></i> ${M(e.upspeed)}</div>
            </div>
            <div class="actions-col">
                <button class="btn-icon-s action-toggle" title="Pause/Resume">
                    <i data-lucide="${e.state==="pausedDL"||e.state==="pausedUP"?"play":"pause"}"></i>
                </button>
                <button class="btn-icon-s delete action-delete" title="Supprimer"><i data-lucide="trash-2"></i></button>
            </div>
        `,t.querySelector(".action-toggle").addEventListener("click",()=>{let s=e.state==="pausedDL"||e.state==="pausedUP";this.singleAction(s?"resume":"pause",e.hash)}),t.querySelector(".action-delete").addEventListener("click",()=>{confirm(`Supprimer ${e.name} ?`)&&this.singleAction("delete",e.hash)}),t}updateRow(e,t){e.querySelector(".torrent-name").textContent=t.name,e.querySelector(".meta-peers").innerHTML=`<i data-lucide="users" class="inline-icon"></i> ${t.num_leechs}L / ${t.num_seeds}S`,e.querySelector(".meta-eta").innerHTML=`<i data-lucide="clock" class="inline-icon"></i> ${ee(t.eta)}`,e.querySelector(".size-col").textContent=P(t.total_size),e.querySelector(".progress-fill").style.width=`${t.progress*100}%`,e.querySelector(".progress-text").textContent=`${(t.progress*100).toFixed(1)}%`,e.querySelector(".speed-down").innerHTML=`<i data-lucide="arrow-down" class="inline-icon"></i> ${M(t.dlspeed)}`,e.querySelector(".speed-up").innerHTML=`<i data-lucide="arrow-up" class="inline-icon"></i> ${M(t.upspeed)}`;let s=e.querySelector(".action-toggle"),n=t.state==="pausedDL"||t.state==="pausedUP"||t.state==="stoppedDL"||t.state==="stoppedUP";s.innerHTML=`<i data-lucide="${n?"play":"pause"}"></i>`,x(),t.state.includes("error")?e.style.borderLeft="4px solid #ef4444":t.progress===1?e.style.borderLeft="4px solid #3b82f6":n?e.style.borderLeft="4px solid #6b7280":e.style.borderLeft="4px solid #10b981"}showAddModal(){this.dom.addModal.classList.add("visible"),this.dom.addOverlay.classList.add("visible"),this.dom.magnetInput.focus()}hideAddModal(){this.dom.addModal.classList.remove("visible"),this.dom.addOverlay.classList.remove("visible"),this.dom.magnetInput.value=""}async addTorrent(){let e=this.dom.magnetInput.value.trim();if(e){this.dom.submitAdd.textContent="Envoi...";try{await fetch("/api/torrent/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({urls:e})}),this.hideAddModal(),this.fetchData()}catch(t){alert("Erreur: "+t.message)}finally{this.dom.submitAdd.textContent="T\xE9l\xE9charger"}}}async handleFileSelect(e){let t=e.target.files[0];if(t){if(!t.name.endsWith(".torrent")){alert("Veuillez s\xE9lectionner un fichier .torrent");return}await this.addTorrentFile(t),e.target.value=""}}async addTorrentFile(e){let t=new FormData;t.append("torrents",e);let s=this.dom.addBtn.innerHTML;this.dom.addBtn.disabled=!0,this.dom.addBtn.innerHTML='<span class="btn-loader"></span>';try{let n=await fetch("/api/torrent/add-file",{method:"POST",body:t});if(n.ok)this.fetchData();else{let i=await n.json();alert("Erreur: "+(i.error||"\xC9chec de l'ajout du torrent"))}}catch(n){console.error(n),alert("Erreur de connexion")}finally{this.dom.addBtn.disabled=!1,this.dom.addBtn.innerHTML=s,x()}}async singleAction(e,t){try{await fetch(`/api/torrent/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hashes:t})}),setTimeout(()=>this.fetchData(),200)}catch(s){console.error(s)}}async globalAction(e){let t=Array.from(this.cache.keys()).join("|");t&&(await fetch(`/api/torrent/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hashes:t})}),setTimeout(()=>this.fetchData(),500))}}});var K,fe=I(()=>{K=class{constructor(){this.socket=io(),this.myId=null,this.peers=new Map,this.dataChannels=new Map,this.devicesGrid=document.getElementById("devicesGrid"),this.fileInput=document.getElementById("localdropFileInput"),this.modal=document.getElementById("transferModal"),this.targetPeerId=null,this.initSocket(),this.initEvents()}initShare(e){let t=window.location.hostname,s=window.location.port;(t==="localhost"||t==="127.0.0.1")&&e&&(t=e);let n=`http://${t}${s?":"+s:""}/#localdrop`,i=document.getElementById("localUrlDisplay");i&&(i.textContent=n);let a=document.getElementById("copyUrlBtn");a&&a.addEventListener("click",()=>{navigator.clipboard.writeText(n);let l=a.innerHTML;a.innerHTML='<i data-lucide="check"></i>',window.lucide&&window.lucide.createIcons(),setTimeout(()=>{a.innerHTML=l,window.lucide&&window.lucide.createIcons()},2e3)});let o=document.getElementById("qrcode");o&&window.QRCode&&(o.innerHTML="",new QRCode(o,{text:n,width:120,height:120,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}))}initSocket(){this.socket.on("init",e=>{this.myId=e.id;let t=document.getElementById("myName"),s=document.getElementById("myAvatar");t&&(t.textContent=e.name),s&&(s.textContent=e.name.charAt(0),s.style.background=this.getAvatarColor(e.name)),this.initShare(e.serverIp)}),this.socket.on("clients-list",e=>{e.forEach(t=>this.addDeviceCard(t))}),this.socket.on("client-connected",e=>{this.addDeviceCard(e)}),this.socket.on("client-disconnected",e=>{this.removeDeviceCard(e),this.peers.has(e)&&(this.peers.get(e).close(),this.peers.delete(e)),this.dataChannels.delete(e)}),this.socket.on("signal",async({from:e,signal:t})=>{this.peers.has(e)||this.createPeerConnection(e,!1);let s=this.peers.get(e);try{if(t.type==="offer"){await s.setRemoteDescription(new RTCSessionDescription(t));let n=await s.createAnswer();await s.setLocalDescription(n),this.socket.emit("signal",{to:e,from:this.myId,signal:n})}else t.type==="answer"?await s.setRemoteDescription(new RTCSessionDescription(t)):t.candidate&&await s.addIceCandidate(new RTCIceCandidate(t))}catch(n){console.error("Signal error:",n)}})}initEvents(){this.fileInput.addEventListener("change",e=>{let t=e.target.files[0];t&&this.targetPeerId&&this.sendFile(this.targetPeerId,t)})}getAvatarColor(e){let t=["#3b82f6","#10b981","#ef4444","#f59e0b","#8b5cf6","#ec4899","#06b6d4"],s=0;for(let n=0;n<e.length;n++)s=e.charCodeAt(n)+((s<<5)-s);return t[Math.abs(s)%t.length]}addDeviceCard(e){let t=this.devicesGrid.querySelector(".no-devices");if(t&&t.remove(),document.getElementById(`device-${e.id}`))return;let s=document.createElement("div");s.id=`device-${e.id}`,s.className="device-card",s.innerHTML=`
            <div class="device-avatar" style="background: ${this.getAvatarColor(e.name)}">${e.name.charAt(0)}</div>
            <div class="device-name">${e.name}</div>
        `,s.addEventListener("click",()=>{this.targetPeerId=e.id,this.fileInput.click()}),this.devicesGrid.appendChild(s)}removeDeviceCard(e){let t=document.getElementById(`device-${e}`);t&&t.remove(),this.devicesGrid.children.length===0&&(this.devicesGrid.innerHTML=`
                <div class="no-devices">
                    <div class="no-devices-icon"><i data-lucide="radar"></i></div>
                    <p>Recherche d'autres appareils sur le r\xE9seau...</p>
                    <p class="subtext">Ouvrez Ultra Dashboard sur un autre appareil pour le voir ici.</p>
                </div>
            `,window.lucide&&window.lucide.createIcons())}createPeerConnection(e,t){let s=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});if(this.peers.set(e,s),s.onicecandidate=n=>{n.candidate&&this.socket.emit("signal",{to:e,from:this.myId,signal:n.candidate})},t){let n=s.createDataChannel("fileTransfer");this.setupDataChannel(e,n),s.createOffer().then(i=>{s.setLocalDescription(i),this.socket.emit("signal",{to:e,from:this.myId,signal:i})})}else s.ondatachannel=n=>{this.setupDataChannel(e,n.channel)};return s}setupDataChannel(e,t){this.dataChannels.set(e,t);let s=[],n=null;t.onopen=()=>console.log(`Data Channel open with ${e}`),t.onclose=()=>console.log(`Data Channel closed with ${e}`),t.onmessage=i=>{let a=i.data;if(typeof a=="string"){let o=JSON.parse(a);o.type==="metadata"&&(n=o.data,s=[],this.showTransferModal(n.name,"R\xE9ception..."))}else{s.push(a);let o=Math.round(s.length*16384/n.size*100);if(this.updateProgress(o),s.length*16384>=n.size){let l=new Blob(s),m=URL.createObjectURL(l),c=document.createElement("a");c.href=m,c.download=n.name,c.click(),URL.revokeObjectURL(m),this.hideTransferModal()}}}}async sendFile(e,t){if(this.peers.has(e))this.dataChannels.get(e).readyState==="open"?this._performSend(e,t):this._performSend(e,t);else{this.createPeerConnection(e,!0);let s=setInterval(()=>{let n=this.dataChannels.get(e);n&&n.readyState==="open"&&(clearInterval(s),this._performSend(e,t))},100)}}_performSend(e,t){let s=this.dataChannels.get(e);if(!s)return;this.showTransferModal(t.name,`Envoi vers ${e}...`),s.send(JSON.stringify({type:"metadata",data:{name:t.name,size:t.size,type:t.type}}));let n=16384,i=new FileReader,a=0;i.onload=l=>{s.send(l.target.result),a+=l.target.result.byteLength;let m=Math.round(a/t.size*100);this.updateProgress(m),a<t.size?o():setTimeout(()=>this.hideTransferModal(),1e3)};let o=()=>{let l=t.slice(a,a+n);i.readAsArrayBuffer(l)};o()}showTransferModal(e,t){this.modal.classList.remove("hidden"),document.getElementById("transferFileName").textContent=e,document.getElementById("transferStatus").textContent=t,this.updateProgress(0)}updateProgress(e){e=Math.min(e,100),document.getElementById("transferPercent").textContent=`${e}%`,document.getElementById("transferProgressFill").style.width=`${e}%`}hideTransferModal(){this.modal.classList.add("hidden")}}});var X,ve=I(()=>{_();X=class{constructor(){this.widgets=[],this.locked=!1,this.initialized=!1,this.init()}async init(){if(this.initialized)return;let e=[{id:"clock",type:"clock",title:"Heure & Date",w:6},{id:"weather",type:"weather",title:"M\xE9t\xE9o",w:3},{id:"quick-actions",type:"quick-actions",title:"Actions Rapides",w:3}];this.widgets=await u.get("ultra-home-widgets",e),this.locked=await u.get("ultra-home-locked",!1),this.renderWidgets(),this.startClock(),this.bindEvents(),this.updateAllWeather(),this.initialized=!0,console.log("\u{1F3E0} Home Module Initialized (SQLite)")}bindEvents(){let e=document.getElementById("addWidgetBtn"),t=document.getElementById("lockWidgetsBtn"),s=document.getElementById("closeWidgetStore"),n=document.getElementById("widgetStoreOverlay");e&&e.addEventListener("click",()=>this.openWidgetStore()),t&&(t.addEventListener("click",()=>this.toggleLock()),this.updateLockUI()),s&&s.addEventListener("click",()=>this.closeWidgetStore()),n&&n.addEventListener("click",a=>{a.target===n&&this.closeWidgetStore()}),document.querySelectorAll(".store-item").forEach(a=>{a.addEventListener("click",()=>{let o=a.dataset.widgetType;this.addWidget(o),this.closeWidgetStore()})})}openWidgetStore(){let e=document.getElementById("widgetStoreOverlay");e&&e.classList.add("active")}closeWidgetStore(){let e=document.getElementById("widgetStoreOverlay");e&&e.classList.remove("active")}async toggleLock(){this.locked=!this.locked,await u.set("ultra-home-locked",this.locked),this.updateLockUI(),this.renderWidgets()}updateLockUI(){let e=document.getElementById("lockWidgetsBtn"),t=document.getElementById("addWidgetBtn");e&&(this.locked?(e.innerHTML='<i data-lucide="lock"></i>',e.classList.add("locked"),e.title="D\xE9verrouiller le dashboard",t&&(t.style.display="none")):(e.innerHTML='<i data-lucide="unlock"></i>',e.classList.remove("locked"),e.title="Verrouiller le dashboard",t&&(t.style.display="flex")),window.lucide&&window.lucide.createIcons())}async addWidget(e){if(this.widgets.find(s=>s.type===e)){console.warn("Widget already exists");return}let t={id:e+"-"+Date.now(),type:e,title:this.getWidgetTitle(e),w:this.getWidgetWidth(e)};this.widgets.push(t),await this.saveWidgets(),this.renderWidgets()}async saveWidgets(){await u.set("ultra-home-widgets",this.widgets)}getWidgetWidth(e){switch(e){case"clock":return 6;case"weather":return 3;case"quick-actions":return 3;case"system":return 3;case"note":return 4;case"news":return 4;case"downloads":return 4;default:return 3}}getWidgetTitle(e){switch(e){case"clock":return"Heure & Date";case"weather":return"M\xE9t\xE9o";case"quick-actions":return"Actions Rapides";case"system":return"Syst\xE8me";case"note":return"Notes";case"news":return"Actualit\xE9s";case"downloads":return"T\xE9l\xE9chargements";default:return"Widget"}}renderWidgets(){let e=document.getElementById("homeWidgetGrid");e&&(e.innerHTML="",this.widgets.forEach(t=>{let s=document.createElement("div");s.id=`widget-instance-${t.id}`,s.className=`widget-card widget-${t.type}`,s.style.gridColumn=`span ${t.w}`,s.innerHTML=this.getWidgetHTML(t);let n=s.querySelector(".btn-remove-widget");n&&n.addEventListener("click",async i=>{i.stopPropagation(),this.widgets=this.widgets.filter(a=>a.id!==t.id),await this.saveWidgets(),this.renderWidgets()}),e.appendChild(s),t.type==="weather"?this.fetchWeatherForWidget(t.id):t.type==="note"?this.initNoteWidget(t.id):t.type==="news"?this.fetchNewsForWidget(t.id):t.type==="downloads"&&this.updateDownloadsForWidget(t.id)}),window.lucide&&window.lucide.createIcons())}getWidgetHTML(e){let t=`
            <div class="widget-header">
                <span class="widget-title">
                    <i data-lucide="${this.getWidgetIcon(e.type)}"></i> ${e.title}
                </span>
                <div class="widget-controls">
                    ${this.locked?"":'<button class="btn-widget-control btn-remove-widget"><i data-lucide="x"></i></button>'}
                </div>
            </div>
        `,s="";switch(e.type){case"clock":s=`
                    <div class="clock-display">
                        <div class="time" id="widgetTime">00:00</div>
                        <div class="date" id="widgetDate">Lundi 1 Janvier</div>
                    </div>
                `;break;case"weather":s=`
                    <div class="weather-content" id="weather-content-${e.id}">
                        <div class="weather-info">
                            <span class="weather-temp">--\xB0C</span>
                            <span class="weather-desc">Chargement...</span>
                        </div>
                        <div class="weather-icon-large">\u23F3</div>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;" id="weather-location-${e.id}">
                        <i data-lucide="map-pin" style="width: 12px"></i> Localisation...
                    </div>
                `;break;case"quick-actions":s=`
                    <div class="quick-actions-grid">
                        <button class="quick-action-btn" onclick="document.querySelector('[data-tab=\\'convert\\']').click()">
                            <i data-lucide="refresh-cw"></i> <span>Convertir</span>
                        </button>
                        <button class="quick-action-btn" onclick="document.querySelector('[data-tab=\\'youtube\\']').click()">
                            <i data-lucide="youtube"></i> <span>YouTube</span>
                        </button>
                    </div>
                `;break;case"note":s=`
                    <textarea id="note-${e.id}" placeholder="\xC9crire une note..."></textarea>
                `;break;case"news":s=`
                    <div class="news-list" id="news-list-${e.id}">
                        <div style="color: var(--text-muted); padding: 20px; text-align: center;">Chargement des actus...</div>
                    </div>
                `;break;case"downloads":s=`
                    <div class="download-status-list" id="download-list-${e.id}">
                        <div style="color: var(--text-muted); padding: 20px; text-align: center;">Aucun t\xE9l\xE9chargement actif</div>
                    </div>
                `;break;default:s='<div style="padding: 20px; text-align: center; color: var(--text-muted)">Contenu du widget...</div>'}return t+s}async initNoteWidget(e){let t=document.getElementById(`note-${e}`);t&&(t.value=await u.get(`ultra-note-${e}`,""),t.addEventListener("input",async s=>{await u.set(`ultra-note-${e}`,s.target.value)}))}async fetchNewsForWidget(e){let t=document.getElementById(`news-list-${e}`);if(t)try{let n=`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent("https://www.franceinfo.fr/titres.rss")}`,a=await(await fetch(n)).json();if(a.status==="ok"){let o=a.items.slice(0,4);t.innerHTML=o.map(l=>`
                    <a href="${l.link}" target="_blank" class="news-item">
                        <span class="news-title">${l.title}</span>
                        <span class="news-meta">France Info \u2022 ${new Date(l.pubDate).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}</span>
                    </a>
                `).join("")}else throw new Error("RSS conversion failed")}catch(s){console.error("News fetch error:",s),t.innerHTML='<div style="color: var(--error); font-size: 0.82rem; text-align: center; padding: 15px;">Impossible de charger les actualit\xE9s.</div>'}}async updateDownloadsForWidget(e){let t=document.getElementById(`download-list-${e}`);if(t)try{let s=await fetch("/api/torrent/list");if(s.ok){let n=await s.json(),i=(Array.isArray(n)?n:[]).filter(a=>a.progress<1).slice(0,2);i.length>0?t.innerHTML=i.map(a=>`
                        <div class="download-item">
                            <div class="download-info">
                                <span class="download-name">${a.name}</span>
                                <span class="download-percent">${Math.round(a.progress*100)}%</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${a.progress*100}%"></div>
                            </div>
                        </div>
                    `).join(""):t.innerHTML='<div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 10px;">Aucun t\xE9l\xE9chargement en cours</div>'}}catch{t.innerHTML='<div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 10px;">Service indisponible</div>'}}updateAllWeather(){this.widgets.filter(e=>e.type==="weather").forEach(e=>this.fetchWeatherForWidget(e.id))}async fetchWeatherForWidget(e){let t={latitude:48.8566,longitude:2.3522,name:"Paris, France"};if(!navigator.geolocation){this.fetchWeatherFromAPI(e,t.latitude,t.longitude,t.name);return}navigator.geolocation.getCurrentPosition(async s=>{let{latitude:n,longitude:i}=s.coords;this.fetchWeatherFromAPI(e,n,i,"Position actuelle")},s=>{this.fetchWeatherFromAPI(e,t.latitude,t.longitude,t.name)},{timeout:5e3})}async fetchWeatherFromAPI(e,t,s,n){try{let i=`https://api.open-meteo.com/v1/forecast?latitude=${t}&longitude=${s}&current_weather=true&timezone=auto`,o=await(await fetch(i)).json();if(o.current_weather){let l={temp:Math.round(o.current_weather.temperature),code:o.current_weather.weathercode,lat:t,lon:s,locationName:n};this.updateWeatherUI(e,l)}}catch(i){console.error("Weather fetch error:",i),this.updateWeatherUI(e,{error:"Erreur API"})}}updateWeatherUI(e,t){let s=document.getElementById(`weather-content-${e}`),n=document.getElementById(`weather-location-${e}`);if(!s)return;if(t.error){s.innerHTML=`<div style="color: var(--error); font-size: 0.9rem; padding: 10px;">${t.error}</div>`;return}let i=this.getWeatherIconByCode(t.code),a=this.getWeatherDescByCode(t.code);s.innerHTML=`
            <div class="weather-info">
                <span class="weather-temp">${t.temp}\xB0C</span>
                <span class="weather-desc">${a}</span>
            </div>
            <div class="weather-icon-large">${i}</div>
        `,n&&(n.innerHTML=`<i data-lucide="map-pin" style="width: 12px"></i> ${t.locationName||"Position actuelle"}`,window.lucide&&window.lucide.createIcons())}getWeatherIconByCode(e){return e===0?"\u2600\uFE0F":e<=3?"\u{1F324}\uFE0F":e<=48?"\u2601\uFE0F":e<=67?"\u{1F327}\uFE0F":e<=77?"\u2744\uFE0F":e<=82?"\u{1F327}\uFE0F":e<=99?"\u26A1":"\u2600\uFE0F"}getWeatherDescByCode(e){return{0:"Ciel d\xE9gag\xE9",1:"Principalement d\xE9gag\xE9",2:"Partiellement nuageux",3:"Couvert",45:"Brouillard",48:"Brouillard givrant",51:"Bruine l\xE9g\xE8re",53:"Bruine mod\xE9r\xE9e",55:"Bruine dense",61:"Pluie l\xE9g\xE8re",63:"Pluie mod\xE9r\xE9e",65:"Pluie forte",71:"Neige l\xE9g\xE8re",73:"Neige mod\xE9r\xE9e",75:"Neige forte",80:"Averses de pluie l\xE9g\xE8res",81:"Averses de pluie mod\xE9r\xE9es",82:"Averses de pluie violentes",95:"Orage",96:"Orage avec gr\xEAle l\xE9g\xE8re",99:"Orage avec gr\xEAle forte"}[e]||"Ensoleill\xE9"}getWidgetIcon(e){switch(e){case"clock":return"clock";case"weather":return"cloud-sun";case"quick-actions":return"zap";case"system":return"cpu";case"note":return"sticky-note";case"news":return"newspaper";case"downloads":return"download";default:return"layout"}}startClock(){let e=()=>{let t=document.getElementById("widgetTime"),s=document.getElementById("widgetDate");if(t&&s){let n=new Date;t.textContent=n.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),s.textContent=n.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})}};e(),setInterval(e,1e3)}}});var Y,ye=I(()=>{Y=class{constructor(){this.items=[],this.currentPage=1,this.limit=20,this.isLoading=!1,this.elements={grid:document.getElementById("databankGrid"),refreshBtn:document.getElementById("databankRefreshBtn"),clearBtn:document.getElementById("databankClearBtn"),search:document.getElementById("databankSearch"),filterType:document.getElementById("databankFilterType"),prevBtn:document.getElementById("databankPrevBtn"),nextBtn:document.getElementById("databankNextBtn"),pageInfo:document.getElementById("databankPageInfo"),pagination:document.getElementById("databankPagination"),previewModal:document.getElementById("databankPreviewModal"),closePreviewBtn:document.getElementById("closePreviewModal"),previewBody:document.getElementById("previewBody"),previewTitle:document.getElementById("previewTitle"),previewDownloadBtn:document.getElementById("previewDownloadBtn"),previewMeta:document.getElementById("previewMeta")},this.init()}init(){this.setupEventListeners(),window.databankModule=this}onTabActivate(){this.loadItems()}setupEventListeners(){this.elements.refreshBtn.addEventListener("click",()=>this.loadItems()),this.elements.clearBtn.addEventListener("click",()=>this.clearAll()),this.elements.search.addEventListener("input",this.debounce(()=>this.loadItems(1),500)),this.elements.filterType.addEventListener("change",()=>this.loadItems(1)),this.elements.prevBtn.addEventListener("click",()=>{this.currentPage>1&&this.loadItems(this.currentPage-1)}),this.elements.nextBtn.addEventListener("click",()=>{this.loadItems(this.currentPage+1)}),this.elements.closePreviewBtn.addEventListener("click",()=>{this.elements.previewModal.classList.remove("active")}),this.elements.previewModal.addEventListener("click",e=>{e.target===this.elements.previewModal&&this.elements.previewModal.classList.remove("active")})}async loadItems(e=null){if(this.isLoading)return;this.isLoading=!0,e&&(this.currentPage=e);let t=(this.currentPage-1)*this.limit,s=this.elements.filterType.value!=="all"?this.elements.filterType.value:"",n=this.elements.search.value;this.elements.grid.innerHTML=`
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Chargement...</p>
            </div>
        `;try{let i=new URL("/api/databank",window.location.origin);i.searchParams.append("limit",this.limit),i.searchParams.append("offset",t),s&&i.searchParams.append("type",s);let o=await(await fetch(i)).json();this.items=o.items,this.renderItems(),this.updatePagination(o.items.length)}catch(i){console.error("Error loading databank:",i),this.elements.grid.innerHTML=`
                <div class="error-message">
                    <p>Erreur lors du chargement des donn\xE9es</p>
                    <button class="btn-secondary" onclick="window.databankModule.loadItems()">R\xE9essayer</button>
                </div>
            `}finally{this.isLoading=!1}}renderItems(){if(this.items.length===0){this.elements.grid.innerHTML=`
                <div class="empty-state" style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i data-lucide="database" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>Aucune donn\xE9e trouv\xE9e</p>
                </div>
            `,window.lucide&&window.lucide.createIcons();return}this.elements.grid.innerHTML="",this.items.forEach(e=>{let t=document.createElement("div");t.className="databank-item";let s="",n="file";e.type==="image"?(s=`<img src="${e.content}" alt="Image" loading="lazy">`,n="image"):e.type==="audio"?(s='<i data-lucide="music"></i>',n="music"):e.type==="video"?(s='<i data-lucide="video"></i>',n="video"):(s='<i data-lucide="file-text"></i>',n="file-text");let i=new Date(e.created_at).toLocaleString(),a=e.metadata.originalName||e.metadata.title||`Item #${e.id}`,o=e.metadata.tool||"Unknown";t.innerHTML=`
                <div class="databank-preview">
                    ${s}
                    <span class="databank-type-badge">${e.type}</span>
                    <div class="databank-actions">
                        <button class="action-btn" title="T\xE9l\xE9charger" onclick="event.stopPropagation(); window.databankModule.downloadItem(${e.id})">
                            <i data-lucide="download"></i>
                        </button>
                        <button class="action-btn" title="Supprimer" onclick="event.stopPropagation(); window.databankModule.deleteItem(${e.id})">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                </div>
                <div class="databank-info">
                    <h4>${a}</h4>
                    <p>${o} \u2022 ${i}</p>
                </div>
            `,t.addEventListener("click",()=>this.openPreview(e)),this.elements.grid.appendChild(t)}),window.lucide&&window.lucide.createIcons()}updatePagination(e){this.elements.pagination.classList.remove("hidden"),this.elements.pageInfo.textContent=`Page ${this.currentPage}`,this.elements.prevBtn.disabled=this.currentPage===1,this.elements.nextBtn.disabled=e<this.limit}openPreview(e){this.elements.previewTitle.textContent=e.metadata.originalName||`Item #${e.id}`,e.type==="image"?this.elements.previewBody.innerHTML=`<img src="${e.content}" class="preview-image-full" alt="Preview">`:e.type==="text"?this.elements.previewBody.innerHTML=`<div class="preview-text-full">${e.content}</div>`:this.elements.previewBody.innerHTML=`
                <div style="text-align: center; padding: 40px;">
                    <i data-lucide="${e.type==="audio"?"music":"file"}" style="font-size: 64px; margin-bottom: 20px;"></i>
                    <p>Aper\xE7u non disponible pour ce type de fichier.</p>
                </div>
            `,window.lucide&&window.lucide.createIcons();let t=Object.entries(e.metadata).map(([s,n])=>`<div><strong>${s}:</strong> ${n}</div>`).join("");this.elements.previewMeta.innerHTML=`
            <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary); display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>ID:</strong> ${e.id}</div>
                <div><strong>Type:</strong> ${e.type}</div>
                <div><strong>Date:</strong> ${new Date(e.created_at).toLocaleString()}</div>
                ${t}
            </div>
        `,this.elements.previewDownloadBtn.onclick=()=>this.downloadItem(e.id),this.elements.previewModal.classList.add("active")}async downloadItem(e){let t=this.items.find(n=>n.id===e);if(!t)return;let s=document.createElement("a");s.href=t.content,s.download=t.metadata.originalName||`databank-item-${e}`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}async deleteItem(e){if(confirm("Voulez-vous vraiment supprimer cet \xE9l\xE9ment ?"))try{await fetch(`/api/databank/${e}`,{method:"DELETE"}),this.loadItems()}catch(t){console.error("Error deleting item:",t),alert("Erreur lors de la suppression")}}async clearAll(){if(confirm("ATTENTION: Voulez-vous vraiment TOUT effacer ? Cette action est irr\xE9versible."))try{await fetch("/api/databank/clear",{method:"POST"}),this.loadItems()}catch(e){console.error("Error clearing all:",e),alert("Erreur lors du nettoyage")}}debounce(e,t){let s;return function(...i){let a=()=>{clearTimeout(s),e(...i)};clearTimeout(s),s=setTimeout(a,t)}}}});var we,be=I(()=>{_();we=()=>{let r=document.getElementById("plexusForm"),e=document.getElementById("plexusInput"),t=document.getElementById("plexusSendBtn"),s=document.getElementById("plexusSearchWrapper"),n=document.getElementById("plexusLogoContainer"),i=document.getElementById("plexusSuggestions"),a=document.getElementById("plexusResultsArea"),o=document.getElementById("plexusCurrentQuery"),l=document.getElementById("plexusBackBtn"),m=document.getElementById("plexusThinking"),c=document.getElementById("plexusThinkingSteps"),d=document.getElementById("plexusAnswer"),f=document.getElementById("plexusSourcesList"),E=document.getElementById("plexusFollowup"),w=document.getElementById("plexusFollowupList"),T=!1,v=[];window.lucide&&window.lucide.createIcons(),p();async function p(){try{let g=await(await fetch("/api/plexus/health",{credentials:"same-origin"})).json();g.searxng!=="connected"&&console.warn("[Plexus] SearXNG not connected:",g)}catch(h){console.error("[Plexus] Health check failed:",h)}}function b(){m.classList.remove("hidden"),d.innerHTML="",d.classList.remove("typing"),c.innerHTML=`
            <div class="thinking-step active">
                <i data-lucide="search"></i>
                <span>Recherche sur le web...</span>
            </div>
        `,window.lucide&&window.lucide.createIcons()}function y(h){let g={searching:{done:[`
                    <div class="thinking-step done">
                        <i data-lucide="check"></i>
                        <span>Sources trouv\xE9es</span>
                    </div>
                `],active:`
                    <div class="thinking-step active">
                        <i data-lucide="brain"></i>
                        <span>Analyse et synth\xE8se...</span>
                    </div>
                `},generating:{done:[`
                    <div class="thinking-step done">
                        <i data-lucide="check"></i>
                        <span>Sources trouv\xE9es</span>
                    </div>`,`<div class="thinking-step done">
                        <i data-lucide="check"></i>
                        <span>Analyse termin\xE9e</span>
                    </div>
                `],active:`
                    <div class="thinking-step active">
                        <i data-lucide="sparkles"></i>
                        <span>R\xE9daction de la r\xE9ponse...</span>
                    </div>
                `}};g[h]&&(c.innerHTML=g[h].done.join("")+g[h].active,window.lucide&&window.lucide.createIcons())}function L(){m.classList.add("hidden")}function $(h){if(!h||h.length===0){f.innerHTML=`
                <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
                    Aucune source trouv\xE9e
                </div>
            `;return}f.innerHTML=h.map(g=>{let S=new URL(g.url).hostname,k=`https://www.google.com/s2/favicons?domain=${S}&sz=32`;return`
                <a href="${g.url}" target="_blank" rel="noopener noreferrer" class="plexus-source-card">
                    <div class="plexus-source-header">
                        <img src="${k}" alt="" class="source-favicon">
                        <div class="plexus-source-index">${g.index}</div>
                    </div>
                    <div class="plexus-source-info">
                        <div class="plexus-source-title">${O(g.title)}</div>
                        <div class="plexus-source-url">${S}</div>
                    </div>
                </a>
            `}).join("")}function Ee(){f.innerHTML=`
            <div class="plexus-sources-loading">
                <div class="plexus-source-skeleton"></div>
                <div class="plexus-source-skeleton"></div>
                <div class="plexus-source-skeleton"></div>
                <div class="plexus-source-skeleton"></div>
            </div>
        `}function Le(h){L();let g="";window.marked?g=marked.parse(h):g=h.replace(/\n/g,"<br>"),v&&v.length>0&&(g=g.replace(/(\[\d+\])+/g,S=>{let k=S.match(/\d+/g);if(!k)return S;let B=parseInt(k[0])-1,C=v[B];if(C){let R=new URL(C.url).hostname,A=R.replace("www.","").split(".")[0],Te=`https://www.google.com/s2/favicons?domain=${R}&sz=32`,te=k.length-1,ke=te>0?`<span class="citation-plus">+${te}</span>`:"";return`<span class="plexus-citation" data-indices="${k.map(Ce=>parseInt(Ce)-1).join(",")}">
                        <img src="${Te}" alt="" class="citation-favicon">
                        <span class="citation-domain">${A}</span>
                        ${ke}
                    </span>`}return S})),d.innerHTML=g,d.querySelectorAll(".plexus-citation").forEach(S=>{S.addEventListener("click",()=>{let k=S.dataset.indices.split(","),B=parseInt(k[0]),C=f.querySelectorAll(".plexus-source-card");C[B]&&(C[B].scrollIntoView({behavior:"smooth",block:"center"}),k.forEach(R=>{let A=C[parseInt(R)];A&&(A.classList.add("highlight"),setTimeout(()=>A.classList.remove("highlight"),3e3))}))})})}function Be(h){if(!h||h.length===0){E.classList.add("hidden");return}E.classList.remove("hidden"),w.innerHTML=h.map(g=>`
            <button class="plexus-followup-item" data-query="${O(g)}">
                <i data-lucide="corner-down-right"></i>
                <span>${O(g)}</span>
            </button>
        `).join(""),window.lucide&&window.lucide.createIcons(),w.querySelectorAll(".plexus-followup-item").forEach(g=>{g.addEventListener("click",()=>{let S=g.dataset.query;H(S)})})}function Se(h){s.classList.add("hidden"),a.classList.remove("hidden"),o.textContent=h}function xe(){a.classList.add("hidden"),s.classList.remove("hidden"),e.value="",e.focus()}async function H(h){if(!T&&(h=h.trim(),!!h)){T=!0,t.disabled=!0,Se(h),b(),Ee(),E.classList.add("hidden");try{let g=await u.get("ultra-plexus-source-count",3),S=await u.get("ultra-plexus-extra-info",""),B=await(await fetch("/api/plexus/search",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({query:h,settings:{sourceCount:g,extraInfo:S}})})).json();if(console.log("[Plexus] API Response:",B),B.error)throw console.error("[Plexus] API Error Object:",B.error),new Error(typeof B.error=="string"?B.error:B.error.message||"Erreur inconnue");v=B.sources||[],y("searching"),$(v),await new Promise(C=>setTimeout(C,300)),y("generating"),await new Promise(C=>setTimeout(C,200)),Le(B.answer),Be(B.followUpQuestions)}catch(g){console.error("[Plexus] Search error:",g),L(),d.innerHTML=`
                <div style="color: var(--error); padding: 20px; text-align: center;">
                    <p><strong>Erreur lors de la recherche</strong></p>
                    <p style="font-size: 13px; margin-top: 8px;">${O(g.message)}</p>
                    <p style="font-size: 12px; margin-top: 16px; color: var(--text-muted);">
                        V\xE9rifiez que SearXNG est accessible sur le port 8080
                    </p>
                </div>
            `,f.innerHTML=""}finally{T=!1,t.disabled=!1}}}function O(h){let g=document.createElement("div");return g.textContent=h,g.innerHTML}r.addEventListener("submit",h=>{h.preventDefault(),H(e.value)}),e.addEventListener("keydown",h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),H(e.value))}),e.addEventListener("input",function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"}),l.addEventListener("click",xe),i.querySelectorAll(".plexus-suggestion").forEach(h=>{h.addEventListener("click",()=>{let g=h.dataset.query;H(g)})})}});var D,Ie=I(()=>{D=class{static async check(){try{return(await(await fetch("/api/auth/status")).json()).authenticated?(this.hideOverlay(),!0):(this.showOverlay(),!1)}catch(e){return console.error("Auth check failed:",e),this.showOverlay(),!1}}static showOverlay(){let e=document.getElementById("authOverlay"),t=document.querySelector(".app");e&&e.classList.remove("hidden"),t&&(t.style.display="none"),window.lucide&&window.lucide.createIcons()}static hideOverlay(){let e=document.getElementById("authOverlay"),t=document.querySelector(".app");e&&e.classList.add("hidden"),t&&(t.style.display="flex")}static async init(){let e=document.getElementById("authForm");if(!e)return;let t=document.getElementById("setupNotice"),s=document.getElementById("authSubtitle"),n=document.getElementById("authSubmit"),i=n.querySelector(".btn-text"),a=!1;try{(await(await fetch("/api/auth/status")).json()).needsSetup&&(a=!0,t.classList.remove("hidden"),s.textContent="Configuration initiale",i.textContent="Cr\xE9er le compte")}catch{}e.addEventListener("submit",async o=>{o.preventDefault();let l=document.getElementById("authUsername").value,m=document.getElementById("authPassword").value,c=document.getElementById("authError");c.classList.add("hidden"),n.disabled=!0,i.textContent="Traitement...";try{let f=await fetch(a?"/api/auth/setup":"/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:l,password:m})}),E=await f.json();f.ok?a?(await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:l,password:m})})).ok&&window.location.reload():window.location.reload():(c.textContent=E.error||"Erreur de connexion",c.classList.remove("hidden"),n.disabled=!1,i.textContent=a?"Cr\xE9er le compte":"Se connecter")}catch{c.textContent="Erreur serveur",c.classList.remove("hidden"),n.disabled=!1,i.textContent=a?"Cr\xE9er le compte":"Se connecter"}}),this.check()}static async logout(){try{await fetch("/api/auth/logout",{method:"POST"}),window.location.reload()}catch(e){console.error("Logout failed:",e)}}}});var Oe=Me(()=>{se();ne();ie();ae();oe();re();le();ce();me();ue();pe();ge();fe();ve();ye();be();Ie();document.addEventListener("DOMContentLoaded",async()=>{await D.init(),new N,new q,new j,new z,new W,new Z,new J,new Q,new V,new G,new K,new Y,new X,de(),he(),we(),document.querySelectorAll(".nav-section-header").forEach(s=>{s.addEventListener("click",()=>{s.parentElement.classList.toggle("collapsed")})});let e=document.querySelector(".nav-item.active");if(e){let s=e.closest(".nav-section");s&&s.classList.remove("collapsed")}window.lucide&&window.lucide.createIcons();let t=document.getElementById("logoutBtn");t&&t.addEventListener("click",()=>D.logout()),console.log("\u{1F680} Ultra Dashboard Loaded (Modular)")})});export default Oe();
